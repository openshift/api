apiVersion: apiextensions.k8s.io/v1 # Hack because controller-gen complains if we don't have this
name: "CRIOCredentialProviderConfig"
crdName: "criocredentialproviderconfigs.config.openshift.io"
featureGates:
  - CRIOCredentialProviderConfig
tests:
  onCreate:
    - name: Should create a valid CRIOCredentialProviderConfig
      initial: |
        apiVersion: config.openshift.io/v1alpha1
        kind: CRIOCredentialProviderConfig
        spec:
          matchImages:
          - 123456789.dkr.ecr.us-east-1.amazonaws.com
          - "*.azurecr.io"
          - gcr.io
          - "*.*.registry.io"
          - registry.io:8080/path
      expected: |
        apiVersion: config.openshift.io/v1alpha1
        kind: CRIOCredentialProviderConfig
        spec:
          matchImages:
          - 123456789.dkr.ecr.us-east-1.amazonaws.com
          - "*.azurecr.io"
          - gcr.io
          - "*.*.registry.io"
          - registry.io:8080/path
        - name: Should reject matchImages with invalid characters
      initial: |
        apiVersion: config.openshift.io/v1alpha1
        kind: CRIOCredentialProviderConfig
        spec:
          matchImages:
          - "reg!stry.io"
      expectedError: "spec.matchImages[0]: Invalid value: \"string\": invalid matchImages value, must be a valid fully qualified domain name with optional wildcard, port, and path"
    - name: Should reject empty matchImages
      initial: |
        apiVersion: config.openshift.io/v1alpha1
        kind: CRIOCredentialProviderConfig
        spec:
          matchImages:
      expectedError: "spec.matchImages: Invalid value: []string{}: must contain at least 1 items"
    - name: Should reject matchImages wildcard in the path
      initial: |
        apiVersion: config.openshift.io/v1alpha1
        kind: CRIOCredentialProviderConfig
        spec:
          matchImages:
          - "registry.io:8080/pa*th"
      expectedError: "spec.matchImages[0]: Invalid value: \"string\": invalid matchImages value, must be a valid fully qualified domain name with optional wildcard, port, and path"
    - name: Should reject wildcard for partial subdomains
      initial: |
        apiVersion: config.openshift.io/v1alpha1
        kind: CRIOCredentialProviderConfig
        spec:
          matchImages:
          - "example.app*.com"
      expectedError: "spec.matchImages[0]: Invalid value: \"string\": invalid matchImages value, must be a valid fully qualified domain name with optional wildcard, port, and path"