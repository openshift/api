package openapi

import (
	"bytes"
	"fmt"
	"os"
	"path/filepath"

	"github.com/openshift/api/tools/codegen/pkg/utils"
	"k8s.io/gengo/args"
	"k8s.io/klog/v2"
	"k8s.io/kube-openapi/pkg/generators"
)

// generateDeepcopyFunctions generates the OpenAPI functions for the given API package paths.
func generateOpenAPIDefinitions(inputPaths []string, outputPackagePath, outputBaseFileName, headerFilePath string, verify bool) error {
	// This is the expected path to the output file.
	// This is what we will compare against if verify is true.
	outputFile := filepath.Join(outputPackagePath, outputBaseFileName+".go")

	if verify {
		outputPackageBase := filepath.Base(outputPackagePath)

		tmpDir, err := os.MkdirTemp("", "codegen-openapi-verify-*")
		if err != nil {
			return fmt.Errorf("failed to create temporary directory: %w", err)
		}
		defer os.RemoveAll(tmpDir)

		outputPackagePath = filepath.Join(tmpDir, outputPackageBase)
	}

	arguments := args.GeneratorArgs{
		InputDirs:                  inputPaths,
		OutputPackagePath:          outputPackagePath,
		OutputFileBaseName:         outputBaseFileName,
		GeneratedBuildTag:          "ignore_autogenerated",
		GeneratedByCommentTemplate: "// Code generated by openapi-gen. DO NOT EDIT.",
		GoHeaderFilePath:           headerFilePath,
	}

	klog.V(2).Infof("Generating openapi into %s", outputPackagePath)

	if err := arguments.Execute(
		generators.NameSystems(),
		generators.DefaultNameSystem(),
		generators.Packages,
	); err != nil {
		return fmt.Errorf("error executing openapi generator: %w", err)
	}

	if verify {
		return verifyDiff(outputFile, outputPackagePath, outputBaseFileName)
	}

	return nil
}

// verifyDiff compares the generated file we put in the temporary directory
// with the current file in the expected location.
// It returns a diff in the error if the files are different.
func verifyDiff(currentFile, outputPackagePath, outputBaseFileName string) error {
	verifyFile := filepath.Join(outputPackagePath, outputBaseFileName+".go")

	verifyData, err := os.ReadFile(verifyFile)
	if err != nil {
		return fmt.Errorf("failed to read generated file: %w", err)
	}

	currentData, err := os.ReadFile(currentFile)
	if err != nil {
		return fmt.Errorf("failed to read current file: %w", err)
	}

	if !bytes.Equal(currentData, verifyData) {
		diff := utils.Diff(currentData, verifyData, currentFile)

		return fmt.Errorf("OpenAPI schema for %s is out of date, please regenerate the OpenAPI schema:\n%s", currentFile, diff)
	}

	return nil
}
