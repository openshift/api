apiVersion: apiextensions.k8s.io/v1 # Hack because controller-gen complains if we don't have this
name: "Network"
crdName: networks.operator.openshift.io
featureGates:
- NoOverlayMode
tests:
  onCreate:
  - name: Should be able to create Network with Geneve transport (default)
    initial: |
      apiVersion: operator.openshift.io/v1
      kind: Network
      spec:
        defaultNetwork:
          ovnKubernetesConfig:
            defaultNetworkTransport: Geneve
    expected: |
      apiVersion: operator.openshift.io/v1
      kind: Network
      spec:
        disableNetworkDiagnostics: false
        logLevel: Normal
        operatorLogLevel: Normal
        defaultNetwork:
          ovnKubernetesConfig:
            defaultNetworkTransport: Geneve
            ipsecConfig:
              mode: Disabled
  - name: Should fail if NoOverlay transport is set without NoOverlayOptions
    initial: |
      apiVersion: operator.openshift.io/v1
      kind: Network
      spec:
        defaultNetwork:
          ovnKubernetesConfig:
            defaultNetworkTransport: NoOverlay
    expectedError: "defaultNetworkNoOverlayOptions must be set if and only if defaultNetworkTransport is NoOverlay"
  - name: Should fail if NoOverlayOptions is set with Geneve transport
    initial: |
      apiVersion: operator.openshift.io/v1
      kind: Network
      spec:
        defaultNetwork:
          ovnKubernetesConfig:
            defaultNetworkTransport: Geneve
            defaultNetworkNoOverlayOptions:
              outboundSNAT: Enabled
              routing: Unmanaged
    expectedError: "defaultNetworkNoOverlayOptions must be set if and only if defaultNetworkTransport is NoOverlay"
  - name: Should be able to create Network with NoOverlay transport and Unmanaged routing
    initial: |
      apiVersion: operator.openshift.io/v1
      kind: Network
      spec:
        defaultNetwork:
          ovnKubernetesConfig:
            defaultNetworkTransport: NoOverlay
            defaultNetworkNoOverlayOptions:
              outboundSNAT: Enabled
              routing: Unmanaged
    expected: |
      apiVersion: operator.openshift.io/v1
      kind: Network
      spec:
        disableNetworkDiagnostics: false
        logLevel: Normal
        operatorLogLevel: Normal
        defaultNetwork:
          ovnKubernetesConfig:
            defaultNetworkTransport: NoOverlay
            defaultNetworkNoOverlayOptions:
              outboundSNAT: Enabled
              routing: Unmanaged
            ipsecConfig:
              mode: Disabled
  - name: Should fail to create Network with outboundSNAT Disabled at installation time
    initial: |
      apiVersion: operator.openshift.io/v1
      kind: Network
      spec:
        defaultNetwork:
          ovnKubernetesConfig:
            defaultNetworkTransport: NoOverlay
            defaultNetworkNoOverlayOptions:
              outboundSNAT: Disabled
              routing: Unmanaged
    expectedError: "outboundSNAT must be Enabled at installation time and can be changed on day 2"
  - name: Should fail if routing is Managed without BGPManagedConfig
    initial: |
      apiVersion: operator.openshift.io/v1
      kind: Network
      spec:
        defaultNetwork:
          ovnKubernetesConfig:
            defaultNetworkTransport: NoOverlay
            defaultNetworkNoOverlayOptions:
              outboundSNAT: Enabled
              routing: Managed
    expectedError: "bgpManagedConfig is required when defaultNetworkNoOverlayOptions.routing is Managed"
  - name: Should be able to create Network with NoOverlay transport and Managed routing with BGPManagedConfig
    initial: |
      apiVersion: operator.openshift.io/v1
      kind: Network
      spec:
        defaultNetwork:
          ovnKubernetesConfig:
            defaultNetworkTransport: NoOverlay
            defaultNetworkNoOverlayOptions:
              outboundSNAT: Enabled
              routing: Managed
            bgpManagedConfig:
              bgpTopology: FullMesh
    expected: |
      apiVersion: operator.openshift.io/v1
      kind: Network
      spec:
        disableNetworkDiagnostics: false
        logLevel: Normal
        operatorLogLevel: Normal
        defaultNetwork:
          ovnKubernetesConfig:
            defaultNetworkTransport: NoOverlay
            defaultNetworkNoOverlayOptions:
              outboundSNAT: Enabled
              routing: Managed
            bgpManagedConfig:
              asNumber: 64512
              bgpTopology: FullMesh
            ipsecConfig:
              mode: Disabled
  onUpdate:
  - name: Should not allow changing defaultNetworkTransport
    initial: |
      apiVersion: operator.openshift.io/v1
      kind: Network
      spec:
        defaultNetwork:
          ovnKubernetesConfig:
            defaultNetworkTransport: Geneve
    updated: |
      apiVersion: operator.openshift.io/v1
      kind: Network
      spec:
        defaultNetwork:
          ovnKubernetesConfig:
            defaultNetworkTransport: NoOverlay
            defaultNetworkNoOverlayOptions:
              outboundSNAT: Disabled
              routing: Unmanaged
    expectedError: "defaultNetworkTransport can only be set at installation time"
  - name: Should allow changing outboundSNAT in defaultNetworkNoOverlayOptions on day 2
    initial: |
      apiVersion: operator.openshift.io/v1
      kind: Network
      spec:
        defaultNetwork:
          ovnKubernetesConfig:
            defaultNetworkTransport: NoOverlay
            defaultNetworkNoOverlayOptions:
              outboundSNAT: Enabled
              routing: Unmanaged
    updated: |
      apiVersion: operator.openshift.io/v1
      kind: Network
      spec:
        defaultNetwork:
          ovnKubernetesConfig:
            defaultNetworkTransport: NoOverlay
            defaultNetworkNoOverlayOptions:
              outboundSNAT: Disabled
              routing: Unmanaged
    expected: |
      apiVersion: operator.openshift.io/v1
      kind: Network
      spec:
        disableNetworkDiagnostics: false
        logLevel: Normal
        operatorLogLevel: Normal
        defaultNetwork:
          ovnKubernetesConfig:
            defaultNetworkTransport: NoOverlay
            defaultNetworkNoOverlayOptions:
              outboundSNAT: Disabled
              routing: Unmanaged
            ipsecConfig:
              mode: Disabled
  - name: Should not allow changing routing in defaultNetworkNoOverlayOptions
    initial: |
      apiVersion: operator.openshift.io/v1
      kind: Network
      spec:
        defaultNetwork:
          ovnKubernetesConfig:
            defaultNetworkTransport: NoOverlay
            defaultNetworkNoOverlayOptions:
              outboundSNAT: Enabled
              routing: Unmanaged
    updated: |
      apiVersion: operator.openshift.io/v1
      kind: Network
      spec:
        defaultNetwork:
          ovnKubernetesConfig:
            defaultNetworkTransport: NoOverlay
            defaultNetworkNoOverlayOptions:
              outboundSNAT: Enabled
              routing: Managed
            bgpManagedConfig:
              bgpTopology: FullMesh
    expectedError: "routing is immutable once set"
  - name: Should allow setting bgpManagedConfig on day 2 if not set at installation time
    initial: |
      apiVersion: operator.openshift.io/v1
      kind: Network
      spec:
        defaultNetwork:
          ovnKubernetesConfig:
            defaultNetworkTransport: NoOverlay
            defaultNetworkNoOverlayOptions:
              outboundSNAT: Enabled
              routing: Unmanaged
    updated: |
      apiVersion: operator.openshift.io/v1
      kind: Network
      spec:
        defaultNetwork:
          ovnKubernetesConfig:
            defaultNetworkTransport: NoOverlay
            defaultNetworkNoOverlayOptions:
              outboundSNAT: Enabled
              routing: Unmanaged
            bgpManagedConfig:
              bgpTopology: FullMesh
    expected: |
      apiVersion: operator.openshift.io/v1
      kind: Network
      spec:
        disableNetworkDiagnostics: false
        logLevel: Normal
        operatorLogLevel: Normal
        defaultNetwork:
          ovnKubernetesConfig:
            defaultNetworkTransport: NoOverlay
            defaultNetworkNoOverlayOptions:
              outboundSNAT: Enabled
              routing: Unmanaged
            bgpManagedConfig:
              asNumber: 64512
              bgpTopology: FullMesh
            ipsecConfig:
              mode: Disabled
  - name: Should allow changing bgpManagedConfig after initial configuration
    initial: |
      apiVersion: operator.openshift.io/v1
      kind: Network
      spec:
        defaultNetwork:
          ovnKubernetesConfig:
            defaultNetworkTransport: NoOverlay
            defaultNetworkNoOverlayOptions:
              outboundSNAT: Enabled
              routing: Managed
            bgpManagedConfig:
              bgpTopology: FullMesh
    updated: |
      apiVersion: operator.openshift.io/v1
      kind: Network
      spec:
        defaultNetwork:
          ovnKubernetesConfig:
            defaultNetworkTransport: NoOverlay
            defaultNetworkNoOverlayOptions:
              outboundSNAT: Enabled
              routing: Managed
            bgpManagedConfig:
              asNumber: 65000
              bgpTopology: FullMesh
    expected: |
      apiVersion: operator.openshift.io/v1
      kind: Network
      spec:
        disableNetworkDiagnostics: false
        logLevel: Normal
        operatorLogLevel: Normal
        defaultNetwork:
          ovnKubernetesConfig:
            defaultNetworkTransport: NoOverlay
            defaultNetworkNoOverlayOptions:
              outboundSNAT: Enabled
              routing: Managed
            bgpManagedConfig:
              asNumber: 65000
              bgpTopology: FullMesh
            ipsecConfig:
              mode: Disabled
  - name: Should allow removing bgpManagedConfig when routing is Unmanaged
    initial: |
      apiVersion: operator.openshift.io/v1
      kind: Network
      spec:
        defaultNetwork:
          ovnKubernetesConfig:
            defaultNetworkTransport: NoOverlay
            defaultNetworkNoOverlayOptions:
              outboundSNAT: Enabled
              routing: Unmanaged
            bgpManagedConfig:
              bgpTopology: FullMesh
    updated: |
      apiVersion: operator.openshift.io/v1
      kind: Network
      spec:
        defaultNetwork:
          ovnKubernetesConfig:
            defaultNetworkTransport: NoOverlay
            defaultNetworkNoOverlayOptions:
              outboundSNAT: Enabled
              routing: Unmanaged
    expected: |
      apiVersion: operator.openshift.io/v1
      kind: Network
      spec:
        disableNetworkDiagnostics: false
        logLevel: Normal
        operatorLogLevel: Normal
        defaultNetwork:
          ovnKubernetesConfig:
            defaultNetworkTransport: NoOverlay
            defaultNetworkNoOverlayOptions:
              outboundSNAT: Enabled
              routing: Unmanaged
            ipsecConfig:
              mode: Disabled
