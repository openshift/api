apiVersion: apiextensions.k8s.io/v1 # Hack because controller-gen complains if we don't have this
name: "CRIOCredentialProviderConfig"
crdName: "criocredentialproviderconfigs.config.openshift.io"
featureGates:
  - CRIOCredentialProviderConfig
tests:
  onCreate:
    - name: Should create a minimal CRIOCredentialProviderConfig
      initial: |
        apiVersion: config.openshift.io/v1
        kind: CRIOCredentialProviderConfig
        metadata:
          name: cluster
        spec: {}
      expected: |
        apiVersion: config.openshift.io/v1
        kind: CRIOCredentialProviderConfig
        metadata:
          name: cluster
        spec: {}
    - name: Should create a valid CRIOCredentialProviderConfig
      initial: |
        apiVersion: config.openshift.io/v1
        kind: CRIOCredentialProviderConfig
        metadata:
          name: cluster
        spec:
          matchImages:
          - 123456789.dkr.ecr.us-east-1.amazonaws.com
          - "*.azurecr.io"
          - gcr.io
          - "*.*.registry.io"
          - registry.io:8080/path
      expected: |
        apiVersion: config.openshift.io/v1
        kind: CRIOCredentialProviderConfig
        metadata:
          name: cluster
        spec:
          matchImages:
          - 123456789.dkr.ecr.us-east-1.amazonaws.com
          - "*.azurecr.io"
          - gcr.io
          - "*.*.registry.io"
          - registry.io:8080/path
    - name: Should reject matchImages with invalid characters
      initial: |
        apiVersion: config.openshift.io/v1
        kind: CRIOCredentialProviderConfig
        metadata:
          name: cluster
        spec:
          matchImages:
          - "reg!stry.io"
      expectedError: "spec.matchImages[0]: Invalid value: \"string\": invalid matchImages value, must be a valid fully qualified domain name in lowercase with optional wildcard, port, and path"
    - name: Should reject matchImages with uppercase hostname
      initial: |
        apiVersion: config.openshift.io/v1
        kind: CRIOCredentialProviderConfig
        metadata:
          name: cluster
        spec:
          matchImages:
          - "Registry.COM"
      expectedError: "spec.matchImages[0]: Invalid value: \"string\": invalid matchImages value, must be a valid fully qualified domain name in lowercase with optional wildcard, port, and path"
    - name: Should reject matchImages with uppercase in the path
      initial: |
        apiVersion: config.openshift.io/v1
        kind: CRIOCredentialProviderConfig
        metadata:
          name: cluster
        spec:
          matchImages:
          - "registry.io/PaTh"
      expectedError: "spec.matchImages[0]: Invalid value: \"string\": invalid matchImages value, must be a valid fully qualified domain name in lowercase with optional wildcard, port, and path"
    - name: Should reject matchImages wildcard in the path
      initial: |
        apiVersion: config.openshift.io/v1
        kind: CRIOCredentialProviderConfig
        metadata:
          name: cluster
        spec:
          matchImages:
          - "registry.io:8080/pa*th"
      expectedError: "spec.matchImages[0]: Invalid value: \"string\": invalid matchImages value, must be a valid fully qualified domain name in lowercase with optional wildcard, port, and path"
    - name: Should reject wildcard for partial subdomains
      initial: |
        apiVersion: config.openshift.io/v1
        kind: CRIOCredentialProviderConfig
        metadata:
          name: cluster
        spec:
          matchImages:
          - "example.app*.com"
      expectedError: "spec.matchImages[0]: Invalid value: \"string\": invalid matchImages value, must be a valid fully qualified domain name in lowercase with optional wildcard, port, and path"
    - name: Should reject global wildcard '*'
      initial: |
        apiVersion: config.openshift.io/v1
        kind: CRIOCredentialProviderConfig
        metadata:
          name: cluster
        spec:
          matchImages:
          - "*"
      expectedError: "spec.matchImages[0]: Invalid value: \"string\": global wildcard '*' is not allowed"
