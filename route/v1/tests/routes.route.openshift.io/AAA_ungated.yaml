apiVersion: apiextensions.k8s.io/v1 # Hack because controller-gen complains if we don't have this
name: "Route"
crdName: routes.route.openshift.io
tests:
  onCreate:
    - name: Should be able to create a minimal Route
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: Service
            name: foo
      expected: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: Service
            name: foo
            weight: 100
          wildcardPolicy: None
    # Host field validation tests
    - name: Should be able to create a Route with a valid host
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          host: my-app.example.com
          to:
            kind: Service
            name: foo
      expected: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          host: my-app.example.com
          to:
            kind: Service
            name: foo
            weight: 100
          wildcardPolicy: None
    - name: Should be able to create a Route with a single label host
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          host: myhost
          to:
            kind: Service
            name: foo
      expected: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          host: myhost
          to:
            kind: Service
            name: foo
            weight: 100
          wildcardPolicy: None
    - name: Should not allow host starting with a hyphen
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          host: -invalid.example.com
          to:
            kind: Service
            name: foo
      expectedError: "spec.host in body should match"
    - name: Should not allow host ending with a hyphen
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          host: invalid-.example.com
          to:
            kind: Service
            name: foo
      expectedError: "spec.host in body should match"
    - name: Should not allow host with invalid characters
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          host: invalid_host.example.com
          to:
            kind: Service
            name: foo
      expectedError: "spec.host in body should match"
    # Subdomain field validation tests
    - name: Should be able to create a Route with a valid subdomain
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          subdomain: frontend
          to:
            kind: Service
            name: foo
      expected: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          subdomain: frontend
          to:
            kind: Service
            name: foo
            weight: 100
          wildcardPolicy: None
    - name: Should be able to create a Route with a multi-part subdomain
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          subdomain: api.v1.frontend
          to:
            kind: Service
            name: foo
      expected: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          subdomain: api.v1.frontend
          to:
            kind: Service
            name: foo
            weight: 100
          wildcardPolicy: None
    - name: Should not allow subdomain starting with a hyphen
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          subdomain: -invalid
          to:
            kind: Service
            name: foo
      expectedError: "spec.subdomain in body should match"
    # Path field validation tests
    - name: Should be able to create a Route with a valid path
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          host: example.com
          path: /api/v1
          to:
            kind: Service
            name: foo
      expected: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          host: example.com
          path: /api/v1
          to:
            kind: Service
            name: foo
            weight: 100
          wildcardPolicy: None
    - name: Should be able to create a Route with a root path
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          host: example.com
          path: /
          to:
            kind: Service
            name: foo
      expected: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          host: example.com
          path: /
          to:
            kind: Service
            name: foo
            weight: 100
          wildcardPolicy: None
    - name: Should not allow path not starting with slash
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          host: example.com
          path: api/v1
          to:
            kind: Service
            name: foo
      expectedError: "spec.path in body should match"
    # to.kind validation tests
    - name: Should be able to create a Route with explicit Service kind
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: Service
            name: my-service
      expected: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: Service
            name: my-service
            weight: 100
          wildcardPolicy: None
    - name: Should be able to create a Route with empty kind (defaults to Service)
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: ""
            name: my-service
      expected: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: ""
            name: my-service
            weight: 100
          wildcardPolicy: None
    - name: Should not allow invalid kind
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: Deployment
            name: my-deployment
      expectedError: "spec.to.kind: Unsupported value"
    # to.name validation tests
    - name: Should not allow empty service name
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: Service
            name: ""
      expectedError: "spec.to.name in body should be at least 1 chars long"
    # to.weight validation tests
    - name: Should be able to create a Route with weight 0
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: Service
            name: foo
            weight: 0
      expected: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: Service
            name: foo
            weight: 0
          wildcardPolicy: None
    - name: Should be able to create a Route with weight 256
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: Service
            name: foo
            weight: 256
      expected: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: Service
            name: foo
            weight: 256
          wildcardPolicy: None
    - name: Should not allow weight greater than 256
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: Service
            name: foo
            weight: 257
      expectedError: "spec.to.weight in body should be less than or equal to 256"
    - name: Should not allow negative weight
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: Service
            name: foo
            weight: -1
      expectedError: "spec.to.weight in body should be greater than or equal to 0"
    # alternateBackends validation tests
    - name: Should be able to create a Route with 3 alternate backends
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: Service
            name: primary
          alternateBackends:
          - kind: Service
            name: backend1
          - kind: Service
            name: backend2
          - kind: Service
            name: backend3
      expected: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: Service
            name: primary
            weight: 100
          alternateBackends:
          - kind: Service
            name: backend1
            weight: 100
          - kind: Service
            name: backend2
            weight: 100
          - kind: Service
            name: backend3
            weight: 100
          wildcardPolicy: None
    - name: Should not allow more than 3 alternate backends
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: Service
            name: primary
          alternateBackends:
          - kind: Service
            name: backend1
          - kind: Service
            name: backend2
          - kind: Service
            name: backend3
          - kind: Service
            name: backend4
      expectedError: "spec.alternateBackends: Too many: 4: must have at most 3 items"
    - name: Should be able to create alternate backend with weight 0
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: Service
            name: primary
          alternateBackends:
          - kind: Service
            name: backend1
            weight: 0
      expected: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: Service
            name: primary
            weight: 100
          alternateBackends:
          - kind: Service
            name: backend1
            weight: 0
          wildcardPolicy: None
    - name: Should not allow alternate backend with weight greater than 256
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: Service
            name: primary
          alternateBackends:
          - kind: Service
            name: backend1
            weight: 300
      expectedError: "spec.alternateBackends[0].weight in body should be less than or equal to 256"
    - name: Should not allow alternate backend with empty name
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: Service
            name: primary
          alternateBackends:
          - kind: Service
            name: ""
      expectedError: "spec.alternateBackends[0].name in body should be at least 1 chars long"
    # wildcardPolicy validation tests
    - name: Should be able to create a Route with wildcardPolicy None
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: Service
            name: foo
          wildcardPolicy: None
      expected: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: Service
            name: foo
            weight: 100
          wildcardPolicy: None
    - name: Should be able to create a Route with wildcardPolicy Subdomain
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          host: www.example.com
          to:
            kind: Service
            name: foo
          wildcardPolicy: Subdomain
      expected: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          host: www.example.com
          to:
            kind: Service
            name: foo
            weight: 100
          wildcardPolicy: Subdomain
    - name: Should be able to create a Route with empty wildcardPolicy (defaults to None)
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: Service
            name: foo
          wildcardPolicy: ""
      expected: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: Service
            name: foo
            weight: 100
          wildcardPolicy: ""
    - name: Should not allow invalid wildcardPolicy
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: Service
            name: foo
          wildcardPolicy: Invalid
      expectedError: "spec.wildcardPolicy: Unsupported value"
    # TLS termination validation tests
    - name: Should be able to create a Route with edge termination
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          host: secure.example.com
          to:
            kind: Service
            name: foo
          tls:
            termination: edge
      expected: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          host: secure.example.com
          to:
            kind: Service
            name: foo
            weight: 100
          tls:
            termination: edge
          wildcardPolicy: None
    - name: Should be able to create a Route with reencrypt termination
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          host: secure.example.com
          to:
            kind: Service
            name: foo
          tls:
            termination: reencrypt
      expected: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          host: secure.example.com
          to:
            kind: Service
            name: foo
            weight: 100
          tls:
            termination: reencrypt
          wildcardPolicy: None
    - name: Should be able to create a Route with passthrough termination
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          host: secure.example.com
          to:
            kind: Service
            name: foo
          tls:
            termination: passthrough
      expected: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          host: secure.example.com
          to:
            kind: Service
            name: foo
            weight: 100
          tls:
            termination: passthrough
          wildcardPolicy: None
    - name: Should not allow invalid TLS termination type
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          host: secure.example.com
          to:
            kind: Service
            name: foo
          tls:
            termination: invalid
      expectedError: "spec.tls.termination: Unsupported value"
    # insecureEdgeTerminationPolicy validation tests
    - name: Should be able to create a Route with insecureEdgeTerminationPolicy Allow
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          host: secure.example.com
          to:
            kind: Service
            name: foo
          tls:
            termination: edge
            insecureEdgeTerminationPolicy: Allow
      expected: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          host: secure.example.com
          to:
            kind: Service
            name: foo
            weight: 100
          tls:
            termination: edge
            insecureEdgeTerminationPolicy: Allow
          wildcardPolicy: None
    - name: Should be able to create a Route with insecureEdgeTerminationPolicy Redirect
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          host: secure.example.com
          to:
            kind: Service
            name: foo
          tls:
            termination: edge
            insecureEdgeTerminationPolicy: Redirect
      expected: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          host: secure.example.com
          to:
            kind: Service
            name: foo
            weight: 100
          tls:
            termination: edge
            insecureEdgeTerminationPolicy: Redirect
          wildcardPolicy: None
    - name: Should not allow invalid insecureEdgeTerminationPolicy
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          host: secure.example.com
          to:
            kind: Service
            name: foo
          tls:
            termination: edge
            insecureEdgeTerminationPolicy: Invalid
      expectedError: "spec.tls.insecureEdgeTerminationPolicy: Unsupported value"
    - name: "cannot have both spec.tls.termination: passthrough and spec.tls.insecureEdgeTerminationPolicy: Allow"
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: Service
            name: foo
          tls:
            termination: passthrough
            insecureEdgeTerminationPolicy: Allow
      expectedError: "cannot have both spec.tls.termination: passthrough and spec.tls.insecureEdgeTerminationPolicy: Allow"
    - name: "spec.tls.termination: passthrough is compatible with spec.tls.insecureEdgeTerminationPolicy: Redirect"
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          host: test.foo
          to:
            kind: Service
            name: foo
          tls:
            termination: passthrough
            insecureEdgeTerminationPolicy: Redirect
      expected: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          host: test.foo
          to:
            kind: Service
            name: foo
            weight: 100
          tls:
            termination: passthrough
            insecureEdgeTerminationPolicy: Redirect
          wildcardPolicy: None
    - name: "spec.tls.termination: passthrough is compatible with spec.tls.insecureEdgeTerminationPolicy: None"
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          host: test.foo
          to:
            kind: Service
            name: foo
          tls:
            termination: passthrough
            insecureEdgeTerminationPolicy: None
      expected: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          host: test.foo
          to:
            kind: Service
            name: foo
            weight: 100
          tls:
            termination: passthrough
            insecureEdgeTerminationPolicy: None
          wildcardPolicy: None
    # Port validation tests
    - name: Should be able to create a Route with integer targetPort
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: Service
            name: foo
          port:
            targetPort: 8080
      expected: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: Service
            name: foo
            weight: 100
          port:
            targetPort: 8080
          wildcardPolicy: None
    - name: Should be able to create a Route with string targetPort
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: Service
            name: foo
          port:
            targetPort: http
      expected: |
        apiVersion: route.openshift.io/v1
        kind: Route
        spec:
          to:
            kind: Service
            name: foo
            weight: 100
          port:
            targetPort: http
          wildcardPolicy: None
    - name: Should be able to create a Route with valid actions
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        metadata:
          labels:
            type: sharded
          name: hello-openshift-actions
          namespace: hello-openshift
        spec:
          subdomain: hello-openshift
          tls:
            termination: edge
          to:
            kind: Service
            name: hello-openshift
          httpHeaders:
            actions:
              response:
              - name: X-Frame-Options
                action:
                  type: Set
                  set:
                    value: DENY
              - name: X-Cache-Info
                action:
                  type: Set
                  set:
                    value: "not cacheable; meta data too large"
              - name: X-XSS-Protection
                action:
                  type: Delete
              - name: X-Source
                action:
                  type: Set
                  set:
                    value: "%[res.hdr(X-Value),lower]"         
              request:
              - name: Content-Location
                action:
                  type: Set
                  set:
                    value: /my-first-blog-post
              - name: X-SSL-Client-Cert 
                action:
                  type: Set
                  set:
                    value: "%{+Q}[ssl_c_der,base64]"
              - name:   Content-Language
                action:
                  type: Delete
              - name: X-Target
                action:
                  type: Set
                  set:
                    value: "%[req.hdr(host),lower]"
              - name: X-Conditional
                action:
                  type: Set
                  set:
                    value: "%[req.hdr(Host)] if foo"
              - name: X-Condition
                action:
                  type: Set
                  set:
                    value: "%[req.hdr(Host)]\ if\ foo"
      expected: |
        apiVersion: route.openshift.io/v1
        kind: Route
        metadata:
          labels:
            type: sharded
          name: hello-openshift-actions
          namespace: hello-openshift
        spec:
          subdomain: hello-openshift
          tls:
            termination: edge
          to:
            kind: Service
            name: hello-openshift
            weight: 100
          wildcardPolicy: None      
          httpHeaders:
            actions:
              response:
              - name: X-Frame-Options
                action:
                  type: Set
                  set:
                    value: DENY
              - name: X-Cache-Info
                action:
                  type: Set
                  set:
                    value: "not cacheable; meta data too large"
              - name: X-XSS-Protection
                action:
                  type: Delete
              - name: X-Source
                action:
                  type: Set
                  set:
                    value: "%[res.hdr(X-Value),lower]"        
              request:
              - name: Content-Location
                action:
                  type: Set
                  set:
                    value: /my-first-blog-post
              - name: X-SSL-Client-Cert 
                action:
                  type: Set
                  set:
                    value: "%{+Q}[ssl_c_der,base64]"
              - name:   Content-Language
                action:
                  type: Delete
              - name: X-Target
                action:
                  type: Set
                  set:
                    value: "%[req.hdr(host),lower]"
              - name: X-Conditional
                action:
                  type: Set
                  set:
                    value: "%[req.hdr(Host)] if foo"
              - name: X-Condition
                action:
                  type: Set
                  set:
                    value: "%[req.hdr(Host)]\ if\ foo"
    - name: "Should not allow response header actions if tls termination is set to passthrough"
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        metadata:
          labels:
            type: sharded
          name: hello-openshift-passthrough
          namespace: hello-openshift
        spec:
          subdomain: hello-openshift
          tls:
            termination: passthrough
          to:
            kind: Service
            name: hello-openshift
          httpHeaders:
            actions:
              response:
              - name: X-Frame-Options
                action:
                  type: Set
                  set:
                    value: DENY    
              - name: X-XSS-Protection
                action:
                  type: Delete
      expectedError: "header actions are not permitted when tls termination is passthrough."
    - name: "Should not allow request header actions if tls termination is set to passthrough"
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        metadata:
          labels:
            type: sharded
          name: hello-openshift-passthrough
          namespace: hello-openshift
        spec:
          subdomain: hello-openshift
          tls:
            termination: passthrough
          to:
            kind: Service
            name: hello-openshift
          httpHeaders:
            actions:
              request:
              - name: Content-Location
                action:
                  type: Set
                  set:
                    value: /my-first-blog-post
              - name: X-SSL-Client-Cert 
                action:
                  type: Set
                  set:
                    value: "%{+Q}[ssl_c_der,base64]"
              - name:   Content-Language
                action:
                  type: Delete
              - name: X-Target
                action:
                  type: Set
                  set:
                    value: "%[req.hdr(host),lower]"
      expectedError: "header actions are not permitted when tls termination is passthrough."
    - name: Should not allow to set/delete HSTS header.
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        metadata:
          labels:
            type: sharded
          name: hello-openshift-edge-hsts
          namespace: hello-openshift
        spec:
          subdomain: hello-openshift
          tls:
            termination: edge
          to:
            kind: Service
            name: hello-openshift
          httpHeaders:
            actions:
              response:
              - name: X-Frame-Options
                action:
                  type: Set
                  set:
                    value: DENY
              - name: Strict-Transport-Security
                action:
                  type: Delete
              request:
              - name: Content-Location
                action:
                  type: Set
                  set:
                    value: /my-first-blog-post
              - name:   Content-Language
                action:
                  type: Delete
      expectedError: "strict-transport-security header may not be modified via header actions"
    - name: Should not allow to set proxy request header.
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        metadata:
          name: hello-openshift-edge-proxy
          namespace: hello-openshift
        spec:
          subdomain: hello-openshift
          tls:
            termination: edge
          to:
            kind: Service
            name: hello-openshift
          httpHeaders:
            actions:
              request:
              - name: Proxy
                action:
                  type: Set
                  set: 
                    value: example.xyz
      expectedError: "proxy header may not be modified via header actions"
    - name: Should not allow to set cookie header.
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        metadata:
          name: hello-openshift-edge-proxy
          namespace: hello-openshift
        spec:
          subdomain: hello-openshift
          tls:
            termination: edge
          to:
            kind: Service
            name: hello-openshift
          httpHeaders:
            actions:
              request:
              - name: Cookie
                action:
                  type: Set
                  set: 
                    value: "PHPSESSID=298zf09hf012fh2; csrftoken=u32t4o3tb3gg43; _gat=1"
      expectedError: "cookie header may not be modified via header actions"
    - name: Should not allow to set set-cookie header.
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        metadata:
          name: hello-openshift-edge-proxy
          namespace: hello-openshift
        spec:
          subdomain: hello-openshift
          tls:
            termination: edge
          to:
            kind: Service
            name: hello-openshift
          httpHeaders:
            actions:
              response:
              - name: Set-Cookie
                action:
                  type: Set
                  set: 
                    value: "sessionId=e8bb43229de9; Domain=foo.example.com"
      expectedError: "set-cookie header may not be modified via header actions"
    - name: Should not allow to set/delete dynamic headers with unclosed braces.
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        metadata:
          labels:
            type: sharded
          name: hello-openshift-edge-unclosed-braces
          namespace: hello-openshift
        spec:
          subdomain: hello-openshift
          tls:
            termination: edge
          to:
            kind: Service
            name: hello-openshift
          httpHeaders:
            actions:
              request:
              - name: Content-Location
                action:
                  type: Set
                  set:
                    value: /my-first-blog-post
              - name:   Content-Language
                action:
                  type: Delete
              - name: expires
                action:
                  type: Set
                  set:
                    value: "%[req.hdr(host),lower"
      expectedError: "Either the header value provided is not in correct format or the sample fetcher/converter specified is not allowed. The dynamic header value will be interpreted as an HAProxy format string as defined in http://cbonte.github.io/haproxy-dconv/2.6/configuration.html#8.2.6 and may use HAProxy's %[] syntax and otherwise must be a valid HTTP header value as defined in https://datatracker.ietf.org/doc/html/rfc7230#section-3.2. Sample fetchers allowed are req.hdr, ssl_c_der. Converters allowed are lower, base64."
    - name: Should not allow to set dynamic response header values with not allowed sample fetchers.
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        metadata:
          labels:
            type: sharded
          name: hello-openshift-edge-not-allowed-values
          namespace: hello-openshift
        spec:
          subdomain: hello-openshift
          tls:
            termination: edge
          to:
            kind: Service
            name: hello-openshift
          httpHeaders:
            actions:
              response:
              - name: X-Target
                action:
                  type: Set
                  set:
                    value: "%{+Q}[ssl_c_der1,base64]"
      expectedError: "Either the header value provided is not in correct format or the sample fetcher/converter specified is not allowed. The dynamic header value will be interpreted as an HAProxy format string as defined in http://cbonte.github.io/haproxy-dconv/2.6/configuration.html#8.2.6 and may use HAProxy's %[] syntax and otherwise must be a valid HTTP header value as defined in https://datatracker.ietf.org/doc/html/rfc7230#section-3.2. Sample fetchers allowed are res.hdr, ssl_c_der. Converters allowed are lower, base64."
    - name: Should not allow to set/delete dynamic response header values with not allowed converters.
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        metadata:
          labels:
            type: sharded
          name: hello-openshift-edge-not-allowed-values
          namespace: hello-openshift
        spec:
          subdomain: hello-openshift
          tls:
            termination: edge
          to:
            kind: Service
            name: hello-openshift
          httpHeaders:
            actions:
              response:
              - name: X-Target
                action:
                  type: Set
                  set:
                    value: "%{+Q}[ssl_c_der,bogus]"
      expectedError: "Either the header value provided is not in correct format or the sample fetcher/converter specified is not allowed. The dynamic header value will be interpreted as an HAProxy format string as defined in http://cbonte.github.io/haproxy-dconv/2.6/configuration.html#8.2.6 and may use HAProxy's %[] syntax and otherwise must be a valid HTTP header value as defined in https://datatracker.ietf.org/doc/html/rfc7230#section-3.2. Sample fetchers allowed are res.hdr, ssl_c_der. Converters allowed are lower, base64."
    - name: Should not allow to set/delete dynamic response header values containing req.hdr fetcher.
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        metadata:
          labels:
            type: sharded
          name: hello-openshift-edge-not-allowed-values
          namespace: hello-openshift
        spec:
          subdomain: hello-openshift
          tls:
            termination: edge
          to:
            kind: Service
            name: hello-openshift
          httpHeaders:
            actions:
              response:
              - name: X-Target
                action:
                  type: Set
                  set:
                    value: "%[req.hdr(host),lower]"
      expectedError: "Either the header value provided is not in correct format or the sample fetcher/converter specified is not allowed. The dynamic header value will be interpreted as an HAProxy format string as defined in http://cbonte.github.io/haproxy-dconv/2.6/configuration.html#8.2.6 and may use HAProxy's %[] syntax and otherwise must be a valid HTTP header value as defined in https://datatracker.ietf.org/doc/html/rfc7230#section-3.2. Sample fetchers allowed are res.hdr, ssl_c_der. Converters allowed are lower, base64."
    - name: Should not allow to set/delete dynamic response header values containing req.hdr fetcher.
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        metadata:
          labels:
            type: sharded
          name: hello-openshift-edge-not-allowed-values
          namespace: hello-openshift
        spec:
          subdomain: hello-openshift
          tls:
            termination: edge
          to:
            kind: Service
            name: hello-openshift
          httpHeaders:
            actions:
              request:
              - name: X-Source
                action:
                  type: Set
                  set:
                    value: "%[res.hdr(X-Value),lower]"
      expectedError: "Either the header value provided is not in correct format or the sample fetcher/converter specified is not allowed. The dynamic header value will be interpreted as an HAProxy format string as defined in http://cbonte.github.io/haproxy-dconv/2.6/configuration.html#8.2.6 and may use HAProxy's %[] syntax and otherwise must be a valid HTTP header value as defined in https://datatracker.ietf.org/doc/html/rfc7230#section-3.2. Sample fetchers allowed are req.hdr, ssl_c_der. Converters allowed are lower, base64."
    - name: Should not allow to set/delete dynamic request header values with not allowed converters.
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        metadata:
          labels:
            type: sharded
          name: hello-openshift-edge-not-allowed-values
          namespace: hello-openshift
        spec:
          subdomain: hello-openshift
          tls:
            termination: edge
          to:
            kind: Service
            name: hello-openshift
          httpHeaders:
            actions:
              request:
              - name: X-SSL-Client-Cert 
                action:
                  type: Set
                  set:
                    value: "%{+Q}[ssl_c_der,bogus]"
              - name:   Content-Language
                action:
                  type: Delete
      expectedError: "Either the header value provided is not in correct format or the sample fetcher/converter specified is not allowed. The dynamic header value will be interpreted as an HAProxy format string as defined in http://cbonte.github.io/haproxy-dconv/2.6/configuration.html#8.2.6 and may use HAProxy's %[] syntax and otherwise must be a valid HTTP header value as defined in https://datatracker.ietf.org/doc/html/rfc7230#section-3.2. Sample fetchers allowed are req.hdr, ssl_c_der. Converters allowed are lower, base64."
    - name: Should not allow to set dynamic request header values with not allowed sample fetchers.
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        metadata:
          labels:
            type: sharded
          name: hello-openshift-edge-not-allowed-values
          namespace: hello-openshift
        spec:
          subdomain: hello-openshift
          tls:
            termination: edge
          to:
            kind: Service
            name: hello-openshift
          httpHeaders:
            actions:
              request:
              - name: X-SSL-Client-Cert 
                action:
                  type: Set
                  set:
                    value: "%{+Q}[ssl_c_der1122,base64]"
              - name:   Content-Language
                action:
                  type: Delete
      expectedError: "Either the header value provided is not in correct format or the sample fetcher/converter specified is not allowed. The dynamic header value will be interpreted as an HAProxy format string as defined in http://cbonte.github.io/haproxy-dconv/2.6/configuration.html#8.2.6 and may use HAProxy's %[] syntax and otherwise must be a valid HTTP header value as defined in https://datatracker.ietf.org/doc/html/rfc7230#section-3.2. Sample fetchers allowed are req.hdr, ssl_c_der. Converters allowed are lower, base64."
    - name: Should not allow empty value in request
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        metadata:
          labels:
            type: sharded
          name: hello-openshift-edge-not-allowed-values
          namespace: hello-openshift
        spec:
          subdomain: hello-openshift
          tls:
            termination: edge
          to:
            kind: Service
            name: hello-openshift
          httpHeaders:
            actions:
              request:
              - name: X-SSL-Client-Cert 
                action:
                  type: Set
                  set:
                    value:
      expectedError: 'Route.route.openshift.io "hello-openshift-edge-not-allowed-values" is invalid: [spec.httpHeaders.actions.request[0].action.set.value: Required value, <nil>: Invalid value: "null": some validation rules were not checked because the object was invalid; correct the existing errors to complete validation]'
    - name: Should not allow empty value in response
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        metadata:
          labels:
            type: sharded
          name: hello-openshift-edge-not-allowed-values
          namespace: hello-openshift
        spec:
          subdomain: hello-openshift
          tls:
            termination: edge
          to:
            kind: Service
            name: hello-openshift
          httpHeaders:
            actions:
              response:
              - name: X-SSL-Client-Cert 
                action:
                  type: Set
                  set:
                    value:
      expectedError: 'Route.route.openshift.io "hello-openshift-edge-not-allowed-values" is invalid: [spec.httpHeaders.actions.response[0].action.set.value: Required value, <nil>: Invalid value: "null": some validation rules were not checked because the object was invalid; correct the existing errors to complete validation]'
    - name: Should be required to specify the set field when the discriminant type is Set.
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        metadata:
          labels:
            type: sharded
          name: hello-openshift-actions
          namespace: hello-openshift
        spec:
          subdomain: hello-openshift
          tls:
            termination: edge
          to:
            kind: Service
            name: hello-openshift
          httpHeaders:
            actions:
              response:
              - name: X-Frame-Options
                action:
                  type: Set
      expectedError: "set is required when type is Set, and forbidden otherwise"
    - name: Should be required to specify the set field when the discriminant type is Set.
      initial: |
        apiVersion: route.openshift.io/v1
        kind: Route
        metadata:
          labels:
            type: sharded
          name: hello-openshift-actions
          namespace: hello-openshift
        spec:
          subdomain: hello-openshift
          tls:
            termination: edge
          to:
            kind: Service
            name: hello-openshift
          httpHeaders:
            actions:
              response:
              - name: X-Frame-Options
                action:
                  set:
                    value: DENY
      expectedError: 'Route.route.openshift.io "hello-openshift-actions" is invalid: [spec.httpHeaders.actions.response[0].action.type: Required value, <nil>: Invalid value: "null": some validation rules were not checked because the object was invalid; correct the existing errors to complete validation]'
