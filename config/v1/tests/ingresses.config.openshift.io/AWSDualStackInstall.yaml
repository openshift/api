apiVersion: apiextensions.k8s.io/v1 # Hack because controller-gen complains if we don't have this
name: "Ingress"
crdName: ingresses.config.openshift.io
featureGates:
- AWSDualStackInstall
tests:
  onCreate:
    - name: Should be able to create an Ingress with default ipFamily
      initial: |
        apiVersion: config.openshift.io/v1
        kind: Ingress
        spec:
          domain: apps.example.com
      expected: |
        apiVersion: config.openshift.io/v1
        kind: Ingress
        spec:
          domain: apps.example.com
          ipFamily: IPv4
    - name: Should be able to create an Ingress with ipFamily set to IPv4
      initial: |
        apiVersion: config.openshift.io/v1
        kind: Ingress
        spec:
          domain: apps.example.com
          ipFamily: IPv4
      expected: |
        apiVersion: config.openshift.io/v1
        kind: Ingress
        spec:
          domain: apps.example.com
          ipFamily: IPv4
    - name: Should be able to create an Ingress with ipFamily set to DualStackIPv6Primary
      initial: |
        apiVersion: config.openshift.io/v1
        kind: Ingress
        spec:
          domain: apps.example.com
          ipFamily: DualStackIPv6Primary
      expected: |
        apiVersion: config.openshift.io/v1
        kind: Ingress
        spec:
          domain: apps.example.com
          ipFamily: DualStackIPv6Primary
    - name: Should be able to create an Ingress with ipFamily set to DualStackIPv4Primary
      initial: |
        apiVersion: config.openshift.io/v1
        kind: Ingress
        spec:
          domain: apps.example.com
          ipFamily: DualStackIPv4Primary
      expected: |
        apiVersion: config.openshift.io/v1
        kind: Ingress
        spec:
          domain: apps.example.com
          ipFamily: DualStackIPv4Primary
    - name: Should not be able to create an Ingress with invalid ipFamily value
      initial: |
        apiVersion: config.openshift.io/v1
        kind: Ingress
        spec:
          domain: apps.example.com
          ipFamily: InvalidValue
      expectedError: "spec.ipFamily: Unsupported value: \"InvalidValue\": supported values: \"IPv4\", \"DualStackIPv6Primary\", \"DualStackIPv4Primary\""
  onUpdate:
    - name: Should default ipFamily to IPv4 when not specified
      initial: |
        apiVersion: config.openshift.io/v1
        kind: Ingress
        spec:
          domain: apps.example.com
      updated: |
        apiVersion: config.openshift.io/v1
        kind: Ingress
        spec:
          domain: apps.example.com
      expected: |
        apiVersion: config.openshift.io/v1
        kind: Ingress
        spec:
          domain: apps.example.com
          ipFamily: IPv4
    - name: Should not allow changing ipFamily once set
      initial: |
        apiVersion: config.openshift.io/v1
        kind: Ingress
        spec:
          domain: apps.example.com
          ipFamily: IPv4
      updated: |
        apiVersion: config.openshift.io/v1
        kind: Ingress
        spec:
          domain: apps.example.com
          ipFamily: DualStackIPv6Primary
      expectedError: "spec.ipFamily: Invalid value: \"string\": ipFamily is immutable once set"
    - name: Should allow setting the same ipFamily value
      initial: |
        apiVersion: config.openshift.io/v1
        kind: Ingress
        spec:
          domain: apps.example.com
          ipFamily: DualStackIPv6Primary
      updated: |
        apiVersion: config.openshift.io/v1
        kind: Ingress
        spec:
          domain: apps.example.com
          ipFamily: DualStackIPv6Primary
      expected: |
        apiVersion: config.openshift.io/v1
        kind: Ingress
        spec:
          domain: apps.example.com
          ipFamily: DualStackIPv6Primary
    - name: Should not allow unsetting ipFamily once it has been set
      initial: |
        apiVersion: config.openshift.io/v1
        kind: Ingress
        spec:
          domain: apps.example.com
          ipFamily: DualStackIPv4Primary
      updated: |
        apiVersion: config.openshift.io/v1
        kind: Ingress
        spec:
          domain: apps.example.com
      expectedError: "spec.ipFamily: Invalid value: \"string\": ipFamily is immutable once set"

