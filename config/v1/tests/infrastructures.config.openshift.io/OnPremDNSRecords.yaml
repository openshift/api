apiVersion: apiextensions.k8s.io/v1 # Hack because controller-gen complains if we don't have this
name: "Infrastructure"
crdName: infrastructures.config.openshift.io
featureGates:
- OnPremDNSRecords
tests:
  onCreate:
    - name: Should be able to create a minimal Infrastructure
      initial: |
        apiVersion: config.openshift.io/v1
        kind: Infrastructure
        spec: {} # No spec is required for a Infrastructure
      expected: |
        apiVersion: config.openshift.io/v1
        kind: Infrastructure
        spec: {}
  onUpdate:
    - name: Status Should contain default fields
      initial: |
        apiVersion: config.openshift.io/v1
        kind: Infrastructure
        spec: {}
        status: {}
      updated: |
        apiVersion: config.openshift.io/v1
        kind: Infrastructure
        spec: {}
        status: {}
      expected: |
        apiVersion: config.openshift.io/v1
        kind: Infrastructure
        spec: {}
        status:
          cpuPartitioning: None
          infrastructureTopology: HighlyAvailable
          controlPlaneTopology: HighlyAvailable
    - name: Should allow setting dnsRecordsType to External
      initial: |
        apiVersion: config.openshift.io/v1
        kind: Infrastructure
        spec:
          platformSpec:
            baremetal: {}
            type: BareMetal
      updated: |
        apiVersion: config.openshift.io/v1
        kind: Infrastructure
        spec:
          platformSpec:
            baremetal: {}
            type: BareMetal
        status:
          platform: BareMetal
          platformStatus:
            baremetal:
              dnsRecordsType: External
            type: BareMetal
      expected: |
        apiVersion: config.openshift.io/v1
        kind: Infrastructure
        spec:
          platformSpec:
            baremetal: {}
            type: BareMetal
        status:
          platform: BareMetal
          platformStatus:
            baremetal:
              dnsRecordsType: External
              loadBalancer:
                type: OpenShiftManagedDefault
            type: BareMetal
          cpuPartitioning: None
          infrastructureTopology: HighlyAvailable
          controlPlaneTopology: HighlyAvailable
    - name: Should not allow setting the dnsRecordsType to a wrong value
      initial: |
        apiVersion: config.openshift.io/v1
        kind: Infrastructure
        spec:
          platformSpec:
            baremetal: {}
            type: BareMetal
      updated: |
        apiVersion: config.openshift.io/v1
        kind: Infrastructure
        spec:
          platformSpec:
            baremetal: {}
            type: BareMetal
        status:
          platform: BareMetal
          platformStatus:
            baremetal:
              dnsRecordsType: Invalid
            type: BareMetal
      expectedStatusError: "platformStatus.baremetal.dnsRecordsType: Unsupported value: \"Invalid\": supported values: \"Internal\", \"External\""
