apiVersion: apiextensions.k8s.io/v1 # Hack because controller-gen complains if we don't have this
name: "UpdateStatus"
crdName: updatestatuses.update.openshift.io
featureGate: UpgradeStatus
tests:
  onCreate:
  - name: Should be able to create a minimal UpdateStatus
    initial: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {} # No spec is required for a UpdateStatus
    expected: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
  onUpdate:
  - name: UpdateStatus can contain a ClusterVersion insight for installation
    initial: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
    updated: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
      status:
        controlPlane:
          resource:
            group: config.openshift.io
            resource: clusterversions
            name: version
          poolResource:
            group: machineconfiguration.openshift.io
            resource: machineconfigpools
            name: master
          informers:
          - name: update-status-controller
            insights:
            - uid: "1234"
              acquiredAt: "2021-01-01T00:00:00Z"
              type: ClusterVersion
              clusterVersion:
                resource:
                  group: config.openshift.io
                  resource: clusterversions
                  name: version
                assessment: Progressing
                versions:
                  previous:
                    version: "<none>"
                    metadata:
                    - key: Installation
                  target:
                    version: 4.18.0
                completion: 42
                startedAt: "2021-01-01T00:00:00Z"
                estimatedCompletedAt: "2021-01-01T02:00:00Z"
                conditions:
                - type: Updating
                  status: "True"
                  lastTransitionTime: "2021-01-01T00:00:00Z"
                  reason: ClusterVersionProgressing
                  message: "Installing version 4.18.0"
          conditions:
          - type: Updating
            status: "True"
            lastTransitionTime: "2021-01-01T00:00:00Z"
            reason: ClusterVersionProgressing
            message: "Installing version 4.18.0"
    expected: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
      status:
        controlPlane:
          resource:
            group: config.openshift.io
            resource: clusterversions
            name: version
          poolResource:
            group: machineconfiguration.openshift.io
            resource: machineconfigpools
            name: master
          informers:
          - name: update-status-controller
            insights:
            - uid: "1234"
              acquiredAt: "2021-01-01T00:00:00Z"
              type: ClusterVersion
              clusterVersion:
                resource:
                  group: config.openshift.io
                  resource: clusterversions
                  name: version
                assessment: Progressing
                versions:
                  previous:
                    version: "<none>"
                    metadata:
                    - key: Installation
                  target:
                    version: 4.18.0
                completion: 42
                startedAt: "2021-01-01T00:00:00Z"
                estimatedCompletedAt: "2021-01-01T02:00:00Z"
                conditions:
                - type: Updating
                  status: "True"
                  lastTransitionTime: "2021-01-01T00:00:00Z"
                  reason: ClusterVersionProgressing
                  message: "Installing version 4.18.0"
          conditions:
          - type: Updating
            status: "True"
            lastTransitionTime: "2021-01-01T00:00:00Z"
            reason: ClusterVersionProgressing
            message: "Installing version 4.18.0"

  - name: UpdateStatus can contain a ClusterVersion insight for update
    initial: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
    updated: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
      status:
        controlPlane:
          resource:
            group: config.openshift.io
            resource: clusterversions
            name: version
          poolResource:
            group: machineconfiguration.openshift.io
            resource: machineconfigpools
            name: master
          informers:
          - name: update-status-controller
            insights:
            - uid: "1234"
              acquiredAt: "2021-01-01T00:00:00Z"
              type: ClusterVersion
              clusterVersion:
                resource:
                  group: config.openshift.io
                  resource: clusterversions
                  name: version
                assessment: Progressing
                versions:
                  previous:
                    version: 4.17.0
                    metadata:
                    - key: Partial
                  target:
                    version: 4.18.0
                completion: 42
                startedAt: "2021-01-01T00:00:00Z"
                estimatedCompletedAt: "2021-01-01T02:00:00Z"
                conditions:
                - type: Updating
                  status: "True"
                  lastTransitionTime: "2021-01-01T00:00:00Z"
                  reason: ClusterVersionProgressing
                  message: "Installing version 4.18.0"
          conditions:
          - type: Updating
            status: "True"
            lastTransitionTime: "2021-01-01T00:00:00Z"
            reason: ClusterVersionProgressing
            message: "Installing version 4.18.0"
    expected: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
      status:
        controlPlane:
          resource:
            group: config.openshift.io
            resource: clusterversions
            name: version
          poolResource:
            group: machineconfiguration.openshift.io
            resource: machineconfigpools
            name: master
          informers:
          - name: update-status-controller
            insights:
            - uid: "1234"
              acquiredAt: "2021-01-01T00:00:00Z"
              type: ClusterVersion
              clusterVersion:
                resource:
                  group: config.openshift.io
                  resource: clusterversions
                  name: version
                assessment: Progressing
                versions:
                  previous:
                    version: 4.17.0
                    metadata:
                    - key: Partial
                  target:
                    version: 4.18.0
                completion: 42
                startedAt: "2021-01-01T00:00:00Z"
                estimatedCompletedAt: "2021-01-01T02:00:00Z"
                conditions:
                - type: Updating
                  status: "True"
                  lastTransitionTime: "2021-01-01T00:00:00Z"
                  reason: ClusterVersionProgressing
                  message: "Installing version 4.18.0"
          conditions:
          - type: Updating
            status: "True"
            lastTransitionTime: "2021-01-01T00:00:00Z"
            reason: ClusterVersionProgressing
            message: "Installing version 4.18.0"

  - name: UpdateStatus refuses invalid installation-like versions in ClusterVersion insights 1
    initial: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
    updated: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
      status:
        controlPlane:
          resource:
            group: config.openshift.io
            resource: clusterversions
            name: version
          poolResource:
            group: machineconfiguration.openshift.io
            resource: machineconfigpools
            name: master
          informers:
          - name: update-status-controller
            insights:
            - uid: "1234"
              acquiredAt: "2021-01-01T00:00:00Z"
              type: ClusterVersion
              clusterVersion:
                resource:
                  group: config.openshift.io
                  resource: clusterversions
                  name: version
                assessment: Progressing
                versions:
                  previous:
                    version: <none>
                  target:
                    version: 4.18.0
                completion: 42
                startedAt: "2021-01-01T00:00:00Z"
                estimatedCompletedAt: "2021-01-01T02:00:00Z"
                conditions:
                - type: Updating
                  status: "True"
                  lastTransitionTime: "2021-01-01T00:00:00Z"
                  reason: ClusterVersionProgressing
                  message: "Installing version 4.18.0"
          conditions:
          - type: Updating
            status: "True"
            lastTransitionTime: "2021-01-01T00:00:00Z"
            reason: ClusterVersionProgressing
            message: "Installing version 4.18.0"
    expected: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
    expectedStatusError: "Invalid value: \"object\": previous version must be '<none>' iff marked with Installation metadata"
  - name: UpdateStatus refuses invalid installation-like versions in ClusterVersion insights 2
    initial: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
    updated: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
      status:
        controlPlane:
          resource:
            group: config.openshift.io
            resource: clusterversions
            name: version
          poolResource:
            group: machineconfiguration.openshift.io
            resource: machineconfigpools
            name: master
          informers:
          - name: update-status-controller
            insights:
            - uid: "1234"
              acquiredAt: "2021-01-01T00:00:00Z"
              type: ClusterVersion
              clusterVersion:
                resource:
                  group: config.openshift.io
                  resource: clusterversions
                  name: version
                assessment: Progressing
                versions:
                  previous:
                    version: 4.17.0
                    metadata:
                    - key: Installation
                  target:
                    version: 4.18.0
                completion: 42
                startedAt: "2021-01-01T00:00:00Z"
                estimatedCompletedAt: "2021-01-01T02:00:00Z"
                conditions:
                - type: Updating
                  status: "True"
                  lastTransitionTime: "2021-01-01T00:00:00Z"
                  reason: ClusterVersionProgressing
                  message: "Installing version 4.18.0"
          conditions:
          - type: Updating
            status: "True"
            lastTransitionTime: "2021-01-01T00:00:00Z"
            reason: ClusterVersionProgressing
            message: "Installing version 4.18.0"
    expected: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
    expectedStatusError: "Invalid value: \"object\": previous version must be '<none>' iff marked with Installation metadata"
  - name: UpdateStatus refuses invalid installation-like versions in ClusterVersion insights 3
    initial: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
    updated: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
      status:
        controlPlane:
          resource:
            group: config.openshift.io
            resource: clusterversions
            name: version
          poolResource:
            group: machineconfiguration.openshift.io
            resource: machineconfigpools
            name: master
          informers:
          - name: update-status-controller
            insights:
            - uid: "1234"
              acquiredAt: "2021-01-01T00:00:00Z"
              type: ClusterVersion
              clusterVersion:
                resource:
                  group: config.openshift.io
                  resource: clusterversions
                  name: version
                assessment: Progressing
                versions:
                  previous:
                    version: 4.17.0
                  target:
                    version: <none>
                    metadata:
                    - key: Installation
                completion: 42
                startedAt: "2021-01-01T00:00:00Z"
                estimatedCompletedAt: "2021-01-01T02:00:00Z"
                conditions:
                - type: Updating
                  status: "True"
                  lastTransitionTime: "2021-01-01T00:00:00Z"
                  reason: ClusterVersionProgressing
                  message: "Installing version 4.18.0"
          conditions:
          - type: Updating
            status: "True"
            lastTransitionTime: "2021-01-01T00:00:00Z"
            reason: ClusterVersionProgressing
            message: "Installing version 4.18.0"
    expected: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
    expectedStatusError: "Invalid value: \"object\": target version must not be '<none>' or have Installation metadata"
  - name: UpdateStatus refuses invalid installation-like versions in ClusterVersion insights 4
    initial: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
    updated: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
      status:
        controlPlane:
          resource:
            group: config.openshift.io
            resource: clusterversions
            name: version
          poolResource:
            group: machineconfiguration.openshift.io
            resource: machineconfigpools
            name: master
          informers:
          - name: update-status-controller
            insights:
            - uid: "1234"
              acquiredAt: "2021-01-01T00:00:00Z"
              type: ClusterVersion
              clusterVersion:
                resource:
                  group: config.openshift.io
                  resource: clusterversions
                  name: version
                assessment: Progressing
                versions:
                  previous:
                    version: 4.17.0
                  target:
                    version: 4.18.0
                    metadata:
                    - key: Installation
                completion: 42
                startedAt: "2021-01-01T00:00:00Z"
                estimatedCompletedAt: "2021-01-01T02:00:00Z"
                conditions:
                - type: Updating
                  status: "True"
                  lastTransitionTime: "2021-01-01T00:00:00Z"
                  reason: ClusterVersionProgressing
                  message: "Installing version 4.18.0"
          conditions:
          - type: Updating
            status: "True"
            lastTransitionTime: "2021-01-01T00:00:00Z"
            reason: ClusterVersionProgressing
            message: "Installing version 4.18.0"
    expected: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
    expectedStatusError: "Invalid value: \"object\": target version must not be '<none>' or have Installation metadata"
  - name: UpdateStatus can contain a ClusterOperator insight
    initial: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
    updated: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
      status:
        controlPlane:
          resource:
            group: config.openshift.io
            resource: clusterversions
            name: version
          informers:
          - name: update-status-controller
            insights:
            - uid: "1234"
              acquiredAt: "2021-01-01T00:00:00Z"
              type: ClusterOperator
              clusterOperator:
                name: image-registry
                resource:
                  group: config.openshift.io
                  resource: clusteroperators
                  name: image-registry
                conditions:
                - type: Updating
                  status: "False"
                  lastTransitionTime: "2021-01-01T00:00:00Z"
                  reason: Pending
                  message: Waiting to be updated
                - type: Healthy
                  status: "False"
                  lastTransitionTime: "2021-01-01T00:00:00Z"
                  reason: Degraded
                  message: Image registry is degraded
          conditions: []
    expected: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
      status:
        controlPlane:
          resource:
            group: config.openshift.io
            resource: clusterversions
            name: version
          informers:
          - name: update-status-controller
            insights:
            - uid: "1234"
              acquiredAt: "2021-01-01T00:00:00Z"
              type: ClusterOperator
              clusterOperator:
                name: image-registry
                resource:
                  group: config.openshift.io
                  resource: clusteroperators
                  name: image-registry
                conditions:
                - type: Updating
                  status: "False"
                  lastTransitionTime: "2021-01-01T00:00:00Z"
                  reason: Pending
                  message: Waiting to be updated
                - type: Healthy
                  status: "False"
                  lastTransitionTime: "2021-01-01T00:00:00Z"
                  reason: Degraded
                  message: Image registry is degraded
          conditions: []

  - name: UpdateStatus can contain a MachineConfigPool insight
    initial: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
    updated: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
      status:
        controlPlane:
          resource:
            group: config.openshift.io
            resource: clusterversions
            name: version
          informers: []
          conditions: []
        workerPools:
        - name: worker
          resource:
            group: machineconfiguration.openshift.io
            resource: machineconfigpools
            name: worker
          informers:
          - name: update-status-controller
            insights:
            - uid: "1234"
              acquiredAt: "2021-01-01T00:00:00Z"
              type: MachineConfigPool
              machineConfigPool:
                name: image-registry
                resource:
                  group: machineconfiguration.openshift.io
                  resource: machineconfigpools
                  name: worker
                scopeType: WorkerPool
                assessment: Completed
                completion: 100
                summaries:
                - type: Total
                  count: 8
                - type: Outdated
                  count: 0
          conditions: []
    expected: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
      status:
        controlPlane:
          resource:
            group: config.openshift.io
            resource: clusterversions
            name: version
          informers: []
          conditions: []
        workerPools:
        - name: worker
          resource:
            group: machineconfiguration.openshift.io
            resource: machineconfigpools
            name: worker
          informers:
          - name: update-status-controller
            insights:
            - uid: "1234"
              acquiredAt: "2021-01-01T00:00:00Z"
              type: MachineConfigPool
              machineConfigPool:
                name: image-registry
                resource:
                  group: machineconfiguration.openshift.io
                  resource: machineconfigpools
                  name: worker
                scopeType: WorkerPool
                assessment: Completed
                completion: 100
                summaries:
                - type: Total
                  count: 8
                - type: Outdated
                  count: 0
          conditions: []
  - name: UpdateStatus can contain a Node insight
    initial: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
    updated: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
      status:
        controlPlane:
          resource:
            group: config.openshift.io
            resource: clusterversions
            name: version
          informers: []
          conditions: []
        workerPools:
        - name: worker
          resource:
            group: machineconfiguration.openshift.io
            resource: machineconfigpools
            name: worker
          informers:
          - name: update-status-controller
            insights:
            - uid: "1234"
              acquiredAt: "2021-01-01T00:00:00Z"
              type: Node
              node:
                name: node-42
                resource:
                  resource: nodes
                  name: node-42
                poolResource:
                  group: machineconfiguration.openshift.io
                  resource: machineconfigpools
                  name: worker
                scopeType: WorkerPool
                version: 4.18.0
                estToComplete: 42m
                message: "Unschedulable | Disk Pressure"
                conditions:
                - type: Updating
                  status: "True"
                  lastTransitionTime: "2021-01-01T00:00:00Z"
                  reason: Draining
                  message: "Node is draining"
                - type: Degraded
                  status: "False"
                  lastTransitionTime: "2021-01-01T00:00:00Z"
                  reason: AsExpected
                  message: "All is well"
                - type: Available
                  status: "False"
                  lastTransitionTime: "2021-01-01T00:00:00Z"
                  reason: MultipleReasons
                  message: "Unschedulable | Disk Pressure"
    expected: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
      status:
        controlPlane:
          resource:
            group: config.openshift.io
            resource: clusterversions
            name: version
          informers: []
          conditions: []
        workerPools:
        - name: worker
          resource:
            group: machineconfiguration.openshift.io
            resource: machineconfigpools
            name: worker
          informers:
          - name: update-status-controller
            insights:
            - uid: "1234"
              acquiredAt: "2021-01-01T00:00:00Z"
              type: Node
              node:
                name: node-42
                resource:
                  resource: nodes
                  name: node-42
                poolResource:
                  group: machineconfiguration.openshift.io
                  resource: machineconfigpools
                  name: worker
                scopeType: WorkerPool
                version: 4.18.0
                estToComplete: 42m
                message: "Unschedulable | Disk Pressure"
                conditions:
                - type: Updating
                  status: "True"
                  lastTransitionTime: "2021-01-01T00:00:00Z"
                  reason: Draining
                  message: "Node is draining"
                - type: Degraded
                  status: "False"
                  lastTransitionTime: "2021-01-01T00:00:00Z"
                  reason: AsExpected
                  message: "All is well"
                - type: Available
                  status: "False"
                  lastTransitionTime: "2021-01-01T00:00:00Z"
                  reason: MultipleReasons
                  message: "Unschedulable | Disk Pressure"

  - name: UpdateStatus can contain a Health insight
    initial: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
    updated: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
      status:
        controlPlane:
          resource:
            group: config.openshift.io
            resource: clusterversions
            name: version
          informers:
          - name: update-status-controller
            insights:
            - uid: "4331"
              acquiredAt: "2021-01-01T00:00:00Z"
              type: Health
              health:
                startedAt: "2021-01-01T00:00:00Z"
                scope:
                  type: ControlPlane
                  resources:
                  - group: config.openshift.io
                    resource: clusterversions
                    name: version
                  - resource: nodes
                    name: node-42
                impact:
                  level: Error
                  type: Cluster Capacity
                  summary: Something that involves a CV and node-42 and affects capacity
                  description: Potentially longer description of the issue
                remediation:
                  reference: https://access.redhat.com/solutions/1234
                  estimatedFinish: "2021-01-01T02:00:00Z"
          conditions: []
    expected: |
      apiVersion: update.openshift.io/v1alpha1
      kind: UpdateStatus
      spec: {}
      status:
        controlPlane:
          resource:
            group: config.openshift.io
            resource: clusterversions
            name: version
          informers:
          - name: update-status-controller
            insights:
            - uid: "4331"
              acquiredAt: "2021-01-01T00:00:00Z"
              type: Health
              health:
                startedAt: "2021-01-01T00:00:00Z"
                scope:
                  type: ControlPlane
                  resources:
                  - group: config.openshift.io
                    resource: clusterversions
                    name: version
                  - resource: nodes
                    name: node-42
                impact:
                  level: Error
                  type: Cluster Capacity
                  summary: Something that involves a CV and node-42 and affects capacity
                  description: Potentially longer description of the issue
                remediation:
                  reference: https://access.redhat.com/solutions/1234
                  estimatedFinish: "2021-01-01T02:00:00Z"
          conditions: []
