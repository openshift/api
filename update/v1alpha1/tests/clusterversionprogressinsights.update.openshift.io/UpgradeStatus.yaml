apiVersion: apiextensions.k8s.io/v1 # Hack because controller-gen complains if we don't have this
name: "ClusterVersionProgressInsight"
crdName: clusterversionprogressinsights.update.openshift.io
featureGate: UpgradeStatus
tests:
  onCreate:
  - name: Should be able to create a minimal ClusterVersionProgressInsight
    initial: |
      apiVersion: update.openshift.io/v1alpha1
      kind: ClusterVersionProgressInsight
      spec: {} # No spec is required for a ClusterVersionProgressInsight
    expected: |
      apiVersion: update.openshift.io/v1alpha1
      kind: ClusterVersionProgressInsight
      spec: {}
  onUpdate:
  - name: ClusterVersionProgressInsight representing installation
    initial: |
      apiVersion: update.openshift.io/v1alpha1
      kind: ClusterVersionProgressInsight
      spec: {}
    updated: |
      apiVersion: update.openshift.io/v1alpha1
      kind: ClusterVersionProgressInsight
      metadata:
        name: version
      spec: {}
      status:
        name: version
        assessment: Progressing
        versions:
          target:
            version: 4.18.0
            metadata:
            - key: Installation
        completionPercent: 42
        startedAt: "2021-01-01T00:00:00Z"
        estimatedCompletedAt: "2021-01-01T02:00:00Z"
        conditions:
        - type: Updating
          status: "True"
          lastTransitionTime: "2021-01-01T00:00:00Z"
          reason: ClusterVersionProgressing
          message: "Installing version 4.18.0"
    expected: |
      apiVersion: update.openshift.io/v1alpha1
      kind: ClusterVersionProgressInsight
      metadata:
        name: version
      spec: {}
      status:
        name: version
        assessment: Progressing
        versions:
          target:
            version: 4.18.0
            metadata:
            - key: Installation
        completionPercent: 42
        startedAt: "2021-01-01T00:00:00Z"
        estimatedCompletedAt: "2021-01-01T02:00:00Z"
        conditions:
        - type: Updating
          status: "True"
          lastTransitionTime: "2021-01-01T00:00:00Z"
          reason: ClusterVersionProgressing
          message: "Installing version 4.18.0"
  - name: ClusterVersionProgressInsight representing update
    initial: |
      apiVersion: update.openshift.io/v1alpha1
      kind: ClusterVersionProgressInsight
      spec: {}
    updated: |
      apiVersion: update.openshift.io/v1alpha1
      kind: ClusterVersionProgressInsight
      metadata:
        name: version
      spec: {}
      status:
        name: version
        assessment: Progressing
        versions:
          previous:
            version: 4.17.0
            metadata:
            - key: Partial
          target:
            version: 4.18.0
        completionPercent: 42
        startedAt: "2021-01-01T00:00:00Z"
        estimatedCompletedAt: "2021-01-01T02:00:00Z"
        conditions:
        - type: Updating
          status: "True"
          lastTransitionTime: "2021-01-01T00:00:00Z"
          reason: ClusterVersionProgressing
          message: "Updating from incomplete 4.17.0 to 4.18.0"
    expected: |
      apiVersion: update.openshift.io/v1alpha1
      kind: ClusterVersionProgressInsight
      metadata:
        name: version
      spec: {}
      status:
        name: version
        assessment: Progressing
        versions:
          previous:
            version: 4.17.0
            metadata:
            - key: Partial
          target:
            version: 4.18.0
        completionPercent: 42
        startedAt: "2021-01-01T00:00:00Z"
        estimatedCompletedAt: "2021-01-01T02:00:00Z"
        conditions:
        - type: Updating
          status: "True"
          lastTransitionTime: "2021-01-01T00:00:00Z"
          reason: ClusterVersionProgressing
          message: "Updating from incomplete 4.17.0 to 4.18.0"
  - name: Previous version can only be empty if target version is marked with Installation metadata
    initial: |
      apiVersion: update.openshift.io/v1alpha1
      kind: ClusterVersionProgressInsight
      spec: {}
    updated: |
      apiVersion: update.openshift.io/v1alpha1
      kind: ClusterVersionProgressInsight
      metadata:
        name: version
      spec: {}
      status:
        name: version
        assessment: Progressing
        versions:
          target:
            version: 4.18.0
        completionPercent: 42
        startedAt: "2021-01-01T00:00:00Z"
        estimatedCompletedAt: "2021-01-01T02:00:00Z"
        conditions:
        - type: Updating
          status: "True"
          lastTransitionTime: "2021-01-01T00:00:00Z"
          reason: ClusterVersionProgressing
          message: "Installing version 4.18.0"
    expected: |
      apiVersion: update.openshift.io/v1alpha1
      kind: ClusterVersionProgressInsight
      spec: {}
    expectedStatusError: "Invalid value: \"object\": target version must have 'Installation' metadata when previous version is empty"
  - name: Target version can only have Installation metadata if previous version is empty
    initial: |
      apiVersion: update.openshift.io/v1alpha1
      kind: ClusterVersionProgressInsight
      spec: {}
    updated: |
      apiVersion: update.openshift.io/v1alpha1
      kind: ClusterVersionProgressInsight
      metadata:
          name: version
      spec: {}
      status:
        name: version
        assessment: Progressing
        versions:
          previous:
            version: 4.17.0
          target:
            version: 4.18.0
            metadata:
            - key: Installation
        completionPercent: 42
        startedAt: "2021-01-01T00:00:00Z"
        estimatedCompletedAt: "2021-01-01T02:00:00Z"
        conditions:
        - type: Updating
          status: "True"
          lastTransitionTime: "2021-01-01T00:00:00Z"
          reason: ClusterVersionProgressing
          message: "Installing version 4.18.0"
    expected: |
      apiVersion: update.openshift.io/v1alpha1
      kind: ClusterVersionProgressInsight
      spec: {}
    expectedStatusError: "Invalid value: \"object\": target version can only have 'Installation' metadata when previous version is empty"
  - name: Previous version cannot have Installation metadata
    initial: |
      apiVersion: update.openshift.io/v1alpha1
      kind: ClusterVersionProgressInsight
      spec: {}
    updated: |
      apiVersion: update.openshift.io/v1alpha1
      kind: ClusterVersionProgressInsight
      metadata:
          name: version
      spec: {}
      status:
        name: version
        assessment: Progressing
        versions:
          previous:
            version: 4.17.0
            metadata:
            - key: Installation
          target:
            version: 4.18.0
        completionPercent: 42
        startedAt: "2021-01-01T00:00:00Z"
        estimatedCompletedAt: "2021-01-01T02:00:00Z"
        conditions:
        - type: Updating
          status: "True"
          lastTransitionTime: "2021-01-01T00:00:00Z"
          reason: ClusterVersionProgressing
          message: "Installing version 4.18.0"
    expected: |
      apiVersion: update.openshift.io/v1alpha1
      kind: ClusterVersionProgressInsight
      spec: {}
    expectedStatusError: "Invalid value: \"object\": previous version cannot have 'Installation' metadata"
  - name: Target version cannot have Partial metadata
    initial: |
      apiVersion: update.openshift.io/v1alpha1
      kind: ClusterVersionProgressInsight
      spec: {}
    updated: |
      apiVersion: update.openshift.io/v1alpha1
      kind: ClusterVersionProgressInsight
      metadata:
        name: version
      spec: {}
      status:
        name: version
        assessment: Progressing
        versions:
          previous:
            version: 4.17.0
          target:
            version: 4.18.0
            metadata:
            - key: Partial
        completionPercent: 42
        startedAt: "2021-01-01T00:00:00Z"
        estimatedCompletedAt: "2021-01-01T02:00:00Z"
        conditions:
        - type: Updating
          status: "True"
          lastTransitionTime: "2021-01-01T00:00:00Z"
          reason: ClusterVersionProgressing
          message: "Installing version 4.18.0"
    expected: |
      apiVersion: update.openshift.io/v1alpha1
      kind: ClusterVersionProgressInsight
      spec: {}
    expectedStatusError: "Invalid value: \"object\": target version cannot have 'Partial' metadata"
  - name: Version must be a semver string
    initial: |
      apiVersion: update.openshift.io/v1alpha1
      kind: ClusterVersionProgressInsight
      spec: {}
    updated: |
      apiVersion: update.openshift.io/v1alpha1
      kind: ClusterVersionProgressInsight
      metadata:
        name: version
      spec: {}
      status:
        name: version
        assessment: Progressing
        versions:
          previous:
            version: not-a-semver
          target:
            version: 4.19.0-0.ci-2025-03-12-113627
        completionPercent: 42
        startedAt: "2021-01-01T00:00:00Z"
        estimatedCompletedAt: "2021-01-01T02:00:00Z"
        conditions:
        - type: Updating
          status: "True"
          lastTransitionTime: "2021-01-01T00:00:00Z"
          reason: ClusterVersionProgressing
          message: "Installing version 4.18.0"
    expected: |
      apiVersion: update.openshift.io/v1alpha1
      kind: ClusterVersionProgressInsight
      spec: {}
    expectedStatusError: "Invalid value: \"not-a-semver\": versions.previous.version in body should match"
#  - name: Name and .status.name must match
#    initial: |
#      apiVersion: update.openshift.io/v1alpha1
#      kind: ClusterVersionProgressInsight
#      spec: {}
#    updated: |
#      apiVersion: update.openshift.io/v1alpha1
#      kind: ClusterVersionProgressInsight
#      metadata:
#          name: version
#      spec: {}
#      status:
#        name: not-version
#        assessment: Progressing
#        versions:
#          previous:
#            version: 4.17.0
#          target:
#            version: 4.18.0
#        completionPercent: 42
#        startedAt: "2021-01-01T00:00:00Z"
#        estimatedCompletedAt: "2021-01-01T02:00:00Z"
#        conditions:
#        - type: Updating
#          status: "True"
#          lastTransitionTime: "2021-01-01T00:00:00Z"
#          reason: ClusterVersionProgressing
#          message: "Installing version 4.18.0"
#    expected: |
#      apiVersion: update.openshift.io/v1alpha1
#      kind: ClusterVersionProgressInsight
#      spec: {}
#    expectedStatusError: "TODO"
