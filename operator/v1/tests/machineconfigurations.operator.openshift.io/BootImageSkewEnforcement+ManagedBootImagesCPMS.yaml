apiVersion: apiextensions.k8s.io/v1 # Hack because controller-gen complains if we don't have this
name: "MachineConfiguration"
crdName: machineconfigurations.operator.openshift.io
featureGates:
- BootImageSkewEnforcement
- ManagedBootImagesCPMS
tests:
  onUpdate:
    - name: Should permit an "All" CPMS boot image configuration when bootImageSkewEnforcementStatus.mode is Automatic
      initial: |
        apiVersion: operator.openshift.io/v1
        kind: MachineConfiguration
        spec: {}
        status:
          managedBootImagesStatus:
            machineManagers:
              - resource: machinesets
                apiGroup: machine.openshift.io
                selection:
                  mode: All
          bootImageSkewEnforcementStatus:
            mode: Automatic         
            automatic:
              ocpVersion: "4.18.2"
              rhcosVersion: "416.94.202411201433-0"
      updated: |
        apiVersion: operator.openshift.io/v1
        kind: MachineConfiguration
        spec: 
          managedBootImages:
            machineManagers:
              - resource: controlplanemachinesets
                apiGroup: machine.openshift.io
                selection:
                  mode: All
        status:
          managedBootImagesStatus:
            machineManagers:
              - resource: machinesets
                apiGroup: machine.openshift.io
                selection:
                  mode: All
          bootImageSkewEnforcementStatus:
            mode: Automatic         
            automatic:
              ocpVersion: "4.18.2"
              rhcosVersion: "416.94.202411201433-0"
      expected: |
        apiVersion: operator.openshift.io/v1
        kind: MachineConfiguration
        spec:
          logLevel: Normal
          operatorLogLevel: Normal  
          managedBootImages:
            machineManagers:
              - resource: controlplanemachinesets
                apiGroup: machine.openshift.io
                selection:
                  mode: All
        status:
          managedBootImagesStatus:
            machineManagers:
              - resource: machinesets
                apiGroup: machine.openshift.io
                selection:
                  mode: All
          bootImageSkewEnforcementStatus:
            mode: Automatic         
            automatic:
              ocpVersion: "4.18.2"
              rhcosVersion: "416.94.202411201433-0"
    - name: Should permit a None CPMS boot image configuration when bootImageSkewEnforcementStatus.mode is Automatic
      initial: |
        apiVersion: operator.openshift.io/v1
        kind: MachineConfiguration
        spec: {}
        status:
          managedBootImagesStatus:
            machineManagers:
              - resource: machinesets
                apiGroup: machine.openshift.io
                selection:
                  mode: All
          bootImageSkewEnforcementStatus:
            mode: Automatic         
            automatic:
              ocpVersion: "4.18.2"
              rhcosVersion: "416.94.202411201433-0"
      updated: |
        apiVersion: operator.openshift.io/v1
        kind: MachineConfiguration
        spec: 
          managedBootImages:
            machineManagers:
              - resource: controlplanemachinesets
                apiGroup: machine.openshift.io
                selection:
                  mode: None
        status:
          managedBootImagesStatus:
            machineManagers:
              - resource: machinesets
                apiGroup: machine.openshift.io
                selection:
                  mode: All
          bootImageSkewEnforcementStatus:
            mode: Automatic         
            automatic:
              ocpVersion: "4.18.2"
              rhcosVersion: "416.94.202411201433-0"
      expected: |
        apiVersion: operator.openshift.io/v1
        kind: MachineConfiguration
        spec:
          logLevel: Normal
          operatorLogLevel: Normal  
          managedBootImages:
            machineManagers:
              - resource: controlplanemachinesets
                apiGroup: machine.openshift.io
                selection:
                  mode: None
        status:
          managedBootImagesStatus:
            machineManagers:
              - resource: machinesets
                apiGroup: machine.openshift.io
                selection:
                  mode: All
          bootImageSkewEnforcementStatus:
            mode: Automatic         
            automatic:
              ocpVersion: "4.18.2"
              rhcosVersion: "416.94.202411201433-0"      
    - name: Should not permit a None MachineSet and All CPMS boot image configuration when bootImageSkewEnforcementStatus.mode is Automatic
      initial: |
        apiVersion: operator.openshift.io/v1
        kind: MachineConfiguration
        spec: {}
        status:
          managedBootImagesStatus:
            machineManagers:
              - resource: machinesets
                apiGroup: machine.openshift.io
                selection:
                  mode: All
          bootImageSkewEnforcementStatus:
            mode: Automatic         
            automatic:
              ocpVersion: "4.18.2"
              rhcosVersion: "416.94.202411201433-0"
      updated: |
        apiVersion: operator.openshift.io/v1
        kind: MachineConfiguration
        spec: 
          managedBootImages:
            machineManagers:
              - resource: controlplanemachinesets
                apiGroup: machine.openshift.io
                selection:
                  mode: All
              - resource: machinesets
                apiGroup: machine.openshift.io
                selection:
                  mode: None                  
        status:
          managedBootImagesStatus:
            machineManagers:
              - resource: machinesets
                apiGroup: machine.openshift.io
                selection:
                  mode: All
          bootImageSkewEnforcementStatus:
            mode: Automatic         
            automatic:
              ocpVersion: "4.18.2"
              rhcosVersion: "416.94.202411201433-0"
      expectedError: "when skew enforcement is in Automatic mode, any MachineAPI MachineSet MachineManager must use selection mode 'All'"
    - name: Should not permit a None MachineSet and None CPMS boot image configuration when bootImageSkewEnforcementStatus.mode is Automatic
      initial: |
        apiVersion: operator.openshift.io/v1
        kind: MachineConfiguration
        spec: {}
        status:
          managedBootImagesStatus:
            machineManagers:
              - resource: machinesets
                apiGroup: machine.openshift.io
                selection:
                  mode: All
          bootImageSkewEnforcementStatus:
            mode: Automatic         
            automatic:
              ocpVersion: "4.18.2"
              rhcosVersion: "416.94.202411201433-0"
      updated: |
        apiVersion: operator.openshift.io/v1
        kind: MachineConfiguration
        spec: 
          managedBootImages:
            machineManagers:
              - resource: controlplanemachinesets
                apiGroup: machine.openshift.io
                selection:
                  mode: None
              - resource: machinesets
                apiGroup: machine.openshift.io
                selection:
                  mode: None                  
        status:
          managedBootImagesStatus:
            machineManagers:
              - resource: machinesets
                apiGroup: machine.openshift.io
                selection:
                  mode: All
          bootImageSkewEnforcementStatus:
            mode: Automatic         
            automatic:
              ocpVersion: "4.18.2"
              rhcosVersion: "416.94.202411201433-0"
      expectedError: "when skew enforcement is in Automatic mode, any MachineAPI MachineSet MachineManager must use selection mode 'All'"      
 
