apiVersion: apiextensions.k8s.io/v1 # Hack because controller-gen complains if we don't have this
name: "[TechPreview] OSStreams"
crdName: osimagestreams.machineconfiguration.openshift.io
featureGates:
  - OSStreams
tests:
  onCreate:
    - name: Should be able to create a minimal OSImageStream
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec: {}
      expected: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec: {}

  onUpdate:
    - name: Should be able to report a well formatted list of image streams
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec: {}
        status: {}
      updated: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec: {}
        status:
          defaultStream: "rhel-coreos"
          availableStreams:
            - name: rhel-coreos
              osImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2
              osExtensionsImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:f9e8d7c6b5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a0f9e8
            - name: rhel10-coreos
              osImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b
              osExtensionsImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:9f8e7d6c5b4a3f2e1d0c9b8a7f6e5d4c3b2a1f0e9d8c7b6a5f4e3d2c1b0a9f8e
      expected: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec: {}
        status:
          defaultStream: "rhel-coreos"
          availableStreams:
            - name: rhel-coreos
              osImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2
              osExtensionsImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:f9e8d7c6b5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a0f9e8
            - name: rhel10-coreos
              osImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b
              osExtensionsImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:9f8e7d6c5b4a3f2e1d0c9b8a7f6e5d4c3b2a1f0e9d8c7b6a5f4e3d2c1b0a9f8e

    - name: Should reject image URL without digest
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec: {}
        status: {}
      updated: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec: {}
        status:
          availableStreams:
            - name: rhel-coreos
              osImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev:latest
              osExtensionsImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:f9e8d7c6b5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a0f9e8
      expectedStatusError: "the OCI Image reference must end with a valid '@sha256:<digest>' suffix"

    - name: Should reject image URL with invalid digest length
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec: {}
        status: {}
      updated: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec: {}
        status:
          defaultStream: "rhel-coreos"
          availableStreams:
            - name: rhel-coreos
              osImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:abc123
              osExtensionsImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:f9e8d7c6b5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a0f9e8
      expectedStatusError: "the OCI Image reference must end with a valid '@sha256:<digest>' suffix, where '<digest>' is 64 characters long"

    - name: Should reject stream name with invalid characters
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec: {}
        status: {}
      updated: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec: {}
        status:
          defaultStream: "rhel@coreos!"
          availableStreams:
            - name: "rhel@coreos!"
              osImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2
              osExtensionsImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:f9e8d7c6b5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a0f9e8
      expectedStatusError: "The name must consist only of alphanumeric characters, hyphens ('-') and dots ('.')"

    - name: Should reject stream name that is too long
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec: {}
        status: {}
      updated: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec: {}
        status:
          defaultStream: "this-is-a-very-long-stream-name-that-exceeds-the-maximum-allowed-length-of-seventy-characters"
          availableStreams:
            - name: "this-is-a-very-long-stream-name-that-exceeds-the-maximum-allowed-length-of-seventy-characters"
              osImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2
              osExtensionsImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:f9e8d7c6b5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a0f9e8
      expectedStatusError: "status.availableStreams[0].name: Too long: may not be more than 70 bytes"

    - name: Should reject image URL without proper host format
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec: {}
        status: {}
      updated: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec: {}
        status:
          defaultStream: "rhel-coreos"
          availableStreams:
            - name: rhel-coreos
              osImageURL: invalid_host/image@sha256:a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2
              osExtensionsImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:f9e8d7c6b5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a0f9e8
      expectedStatusError: "the OCI Image name should follow the host[:port][/namespace]/name format"

    - name: Should accept defaultStream that references an existing stream
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec: {}
        status: {}
      updated: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec: {}
        status:
          defaultStream: rhel-coreos
          availableStreams:
            - name: rhel-coreos
              osImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2
              osExtensionsImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:f9e8d7c6b5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a0f9e8
            - name: rhel10-coreos
              osImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b
              osExtensionsImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:9f8e7d6c5b4a3f2e1d0c9b8a7f6e5d4c3b2a1f0e9d8c7b6a5f4e3d2c1b0a9f8e
      expected: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec: {}
        status:
          defaultStream: rhel-coreos
          availableStreams:
            - name: rhel-coreos
              osImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2
              osExtensionsImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:f9e8d7c6b5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a0f9e8
            - name: rhel10-coreos
              osImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b
              osExtensionsImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:9f8e7d6c5b4a3f2e1d0c9b8a7f6e5d4c3b2a1f0e9d8c7b6a5f4e3d2c1b0a9f8e

    - name: Should reject when availableStreams is not empty but defaultStream is not set
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec: {}
        status: {}
      updated: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec: {}
        status:
          availableStreams:
            - name: rhel-coreos
              osImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2
              osExtensionsImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:f9e8d7c6b5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a0f9e8
      expectedStatusError: "defaultStream must be set when availableStreams is not empty"

    - name: Should reject defaultStream that does not reference an existing stream
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec: {}
        status: {}
      updated: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec: {}
        status:
          defaultStream: non-existent-stream
          availableStreams:
            - name: rhel-coreos
              osImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2
              osExtensionsImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:f9e8d7c6b5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a0f9e8
      expectedStatusError: "defaultStream must reference a stream name from availableStreams"

    - name: Should reject defaultStream with invalid characters
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec: {}
        status: {}
      updated: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec: {}
        status:
          defaultStream: "invalid@stream!"
          availableStreams:
            - name: rhel-coreos
              osImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2
              osExtensionsImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:f9e8d7c6b5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a0f9e8
      expectedStatusError: "The name must consist only of alphanumeric characters, hyphens ('-') and dots ('.')"

    - name: Should reject defaultStream that is too long
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec: {}
        status: {}
      updated: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec: {}
        status:
          defaultStream: "this-is-a-very-long-stream-name-that-exceeds-the-maximum-allowed-length-of-seventy-characters"
          availableStreams:
            - name: rhel-coreos
              osImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2
              osExtensionsImageURL: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:f9e8d7c6b5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a0f9e8
      expectedStatusError: "status.defaultStream: Too long: may not be more than 70 bytes"
