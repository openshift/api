apiVersion: apiextensions.k8s.io/v1 # Hack because controller-gen complains if we don't have this
name: "APIServer"
crdName: apiservers.config.openshift.io
featureGates:
  - HTTP01ChallengeProxy
tests:
  onCreate:
    - name: Should be able to create with HTTP01ChallengeProxy DefaultDeployment mode
      initial: |
        apiVersion: config.openshift.io/v1
        kind: APIServer
        spec:
          http01ChallengeProxy:
            mode: DefaultDeployment
      expected: |
        apiVersion: config.openshift.io/v1
        kind: APIServer
        spec:
          audit:
            profile: Default
          http01ChallengeProxy:
            mode: DefaultDeployment
    - name: Should be able to create with HTTP01ChallengeProxy CustomDeployment mode with port 8888
      initial: |
        apiVersion: config.openshift.io/v1
        kind: APIServer
        spec:
          http01ChallengeProxy:
            mode: CustomDeployment
            customDeployment:
              internalPort: 8888
      expected: |
        apiVersion: config.openshift.io/v1
        kind: APIServer
        spec:
          audit:
            profile: Default
          http01ChallengeProxy:
            mode: CustomDeployment
            customDeployment:
              internalPort: 8888
    - name: Should be able to create with HTTP01ChallengeProxy CustomDeployment mode with minimum port 1024
      initial: |
        apiVersion: config.openshift.io/v1
        kind: APIServer
        spec:
          http01ChallengeProxy:
            mode: CustomDeployment
            customDeployment:
              internalPort: 1024
      expected: |
        apiVersion: config.openshift.io/v1
        kind: APIServer
        spec:
          audit:
            profile: Default
          http01ChallengeProxy:
            mode: CustomDeployment
            customDeployment:
              internalPort: 1024
    - name: Should be able to create with HTTP01ChallengeProxy CustomDeployment mode with maximum port 65535
      initial: |
        apiVersion: config.openshift.io/v1
        kind: APIServer
        spec:
          http01ChallengeProxy:
            mode: CustomDeployment
            customDeployment:
              internalPort: 65535
      expected: |
        apiVersion: config.openshift.io/v1
        kind: APIServer
        spec:
          audit:
            profile: Default
          http01ChallengeProxy:
            mode: CustomDeployment
            customDeployment:
              internalPort: 65535
    - name: Should be able to create with HTTP01ChallengeProxy CustomDeployment mode with valid port 9999
      initial: |
        apiVersion: config.openshift.io/v1
        kind: APIServer
        spec:
          http01ChallengeProxy:
            mode: CustomDeployment
            customDeployment:
              internalPort: 9999
      expected: |
        apiVersion: config.openshift.io/v1
        kind: APIServer
        spec:
          audit:
            profile: Default
          http01ChallengeProxy:
            mode: CustomDeployment
            customDeployment:
              internalPort: 9999
    - name: Should reject DefaultDeployment mode with customDeployment field
      initial: |
        apiVersion: config.openshift.io/v1
        kind: APIServer
        spec:
          http01ChallengeProxy:
            mode: DefaultDeployment
            customDeployment:
              internalPort: 8888
      expectedError: "customDeployment is required when mode is CustomDeployment and forbidden otherwise"
    - name: Should reject CustomDeployment mode without internalPort
      initial: |
        apiVersion: config.openshift.io/v1
        kind: APIServer
        spec:
          http01ChallengeProxy:
            mode: CustomDeployment
            customDeployment: {}
      expectedError: "spec.http01ChallengeProxy.customDeployment.internalPort: Required value"
    - name: Should reject CustomDeployment mode with port below minimum 1023
      initial: |
        apiVersion: config.openshift.io/v1
        kind: APIServer
        spec:
          http01ChallengeProxy:
            mode: CustomDeployment
            customDeployment:
              internalPort: 1023
      expectedError: "Invalid value: 1023: spec.http01ChallengeProxy.customDeployment.internalPort in body should be greater than or equal to 1024"
    - name: Should reject CustomDeployment mode with port above maximum 65536
      initial: |
        apiVersion: config.openshift.io/v1
        kind: APIServer
        spec:
          http01ChallengeProxy:
            mode: CustomDeployment
            customDeployment:
              internalPort: 65536
      expectedError: "should be less than or equal to 65535"
