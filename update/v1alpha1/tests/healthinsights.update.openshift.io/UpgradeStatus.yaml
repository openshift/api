apiVersion: apiextensions.k8s.io/v1 # Hack because controller-gen complains if we don't have this
name: "HealthInsight"
crdName: healthinsights.update.openshift.io
featureGate: UpgradeStatus
tests:
  onCreate:
  - name: Should be able to create a minimal HealthInsight
    initial: |
      apiVersion: update.openshift.io/v1alpha1
      kind: HealthInsight
      spec: {} # No spec is required for a HealthInsight
    expected: |
      apiVersion: update.openshift.io/v1alpha1
      kind: HealthInsight
      spec: {}
  onUpdate:
  - name: HealthInsight example
    initial: |
      apiVersion: update.openshift.io/v1alpha1
      kind: HealthInsight
      spec: {}

    updated: |
      apiVersion: update.openshift.io/v1alpha1
      kind: HealthInsight
      spec: {}
      status:
        startedAt: "2020-01-01T00:00:00Z"
        scope:
          type: WorkerPool
          resources:
          - group: machineconfiguration.openshift.io
            resource: machineconfigpools
            name: worker
          - resource: nodes
            name: node-that-cannot-be-drained
          - resource: pods
            name: pod-that-cannot-be-evicted
          - group: policy
            resource: poddisruptionbudgets
            name: pdb-that-protects-pod
        impact:
          level: Error
          type: Update Stalled
          summary: Node cannot be drained because PDB is protecting a pod
          description: Long message about why this is bad
        remediation:
          reference: https://docs.openshift.com/pdbs-are-hard

    expected: |
      apiVersion: update.openshift.io/v1alpha1
      kind: HealthInsight
      spec: {}
      status:
       startedAt: "2020-01-01T00:00:00Z"
       scope:
         type: WorkerPool
         resources:
         - group: machineconfiguration.openshift.io
           resource: machineconfigpools
           name: worker
         - resource: nodes
           name: node-that-cannot-be-drained
         - resource: pods
           name: pod-that-cannot-be-evicted
         - group: policy
           resource: poddisruptionbudgets
           name: pdb-that-protects-pod
       impact:
         level: Error
         type: Update Stalled
         summary: Node cannot be drained because PDB is protecting a pod
         description: Long message about why this is bad
       remediation:
         reference: https://docs.openshift.com/pdbs-are-hard
  - name: Remediation link must be an URL
    initial: |
      apiVersion: update.openshift.io/v1alpha1
      kind: HealthInsight
      spec: {}

    updated: |
      apiVersion: update.openshift.io/v1alpha1
      kind: HealthInsight
      spec: {}
      status:
        startedAt: "2020-01-01T00:00:00Z"
        scope:
          type: WorkerPool
          resources:
          - group: machineconfiguration.openshift.io
            resource: machineconfigpools
            name: worker
          - resource: nodes
            name: node-that-cannot-be-drained
          - resource: pods
            name: pod-that-cannot-be-evicted
          - group: policy
            resource: poddisruptionbudgets
            name: pdb-that-protects-pod
        impact:
          level: Error
          type: Update Stalled
          summary: Node cannot be drained because PDB is protecting a pod
          description: Long message about why this is bad
        remediation:
          reference: not-a-url

    expected: |
      apiVersion: update.openshift.io/v1alpha1
      kind: HealthInsight
      spec: {}
    expectedStatusError: "reference must a valid URL"
