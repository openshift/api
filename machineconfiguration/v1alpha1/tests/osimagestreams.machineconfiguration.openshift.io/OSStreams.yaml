apiVersion: apiextensions.k8s.io/v1 # Hack because controller-gen complains if we don't have this
name: "[TechPreview] OSStreams"
crdName: osimagestreams.machineconfiguration.openshift.io
featureGates:
  - OSStreams
tests:
  onCreate:
    - name: Should be able to create a minimal OSImageStream
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec: {}
      expected: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec: {}

    - name: Should be able to create an OSImageStream with spec.defaultStream
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
      expected: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos

    - name: Should reject a resource not named cluster
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: another-resource
        spec: {}
      expectedError: "Invalid value: \"object\": osimagestream is a singleton, .metadata.name must be 'cluster'"

    - name: Should reject spec.defaultStream with invalid characters
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: "invalid@stream!"
      expectedError: "a RFC 1123 subdomain must consist of lower case alphanumeric characters, '-' or '.', and must start and end with an alphanumeric character."

    - name: Should reject spec.defaultStream that is too long
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: "this-is-a-very-long-stream-name-that-exceeds-the-maximum-allowed-length-of-253-characters-for-rfc1123-subdomain-validation-which-is-used-to-ensure-compatibility-with-dns-and-kubernetes-naming-standards-and-this-string-needs-to-be-even-longer-to-properly-test-the-limit"
      expectedError: "spec.defaultStream: Too long: may not be more than 253 bytes"

  onUpdate:
    - name: Should be able to report a well formatted list of image streams
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
      updated: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
        status:
          defaultStream: "rhel-coreos"
          availableStreams:
            - name: rhel-coreos
              osImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2
              osExtensionsImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:f9e8d7c6b5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a0f9e8
            - name: rhel10-coreos
              osImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b
              osExtensionsImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:9f8e7d6c5b4a3f2e1d0c9b8a7f6e5d4c3b2a1f0e9d8c7b6a5f4e3d2c1b0a9f8e
      expected: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
        status:
          defaultStream: "rhel-coreos"
          availableStreams:
            - name: rhel-coreos
              osImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2
              osExtensionsImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:f9e8d7c6b5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a0f9e8
            - name: rhel10-coreos
              osImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b
              osExtensionsImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:9f8e7d6c5b4a3f2e1d0c9b8a7f6e5d4c3b2a1f0e9d8c7b6a5f4e3d2c1b0a9f8e

    - name: Should be able to update spec.defaultStream to a different valid value
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
      updated: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel10-coreos
      expected: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel10-coreos

    - name: Should reject updating spec.defaultStream to invalid characters
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
      updated: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: "invalid@stream!"
      expectedError: "a RFC 1123 subdomain must consist of lower case alphanumeric characters, '-' or '.', and must start and end with an alphanumeric character."

    - name: Should reject image URL without digest
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
      updated: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
        status:
          defaultStream: "rhel-coreos"
          availableStreams:
            - name: rhel-coreos
              osImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev:latest
              osExtensionsImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:f9e8d7c6b5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a0f9e8
      expectedStatusError: "the OCI Image reference must end with a valid '@sha256:<digest>' suffix"

    - name: Should reject image URL with invalid digest length
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
      updated: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
        status:
          defaultStream: "rhel-coreos"
          availableStreams:
            - name: rhel-coreos
              osImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:abc123
              osExtensionsImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:f9e8d7c6b5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a0f9e8
      expectedStatusError: "the OCI Image reference must end with a valid '@sha256:<digest>' suffix, where '<digest>' is 64 characters long"

    - name: Should reject stream name with invalid characters
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
      updated: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
        status:
          defaultStream: "rhel@coreos!"
          availableStreams:
            - name: "rhel@coreos!"
              osImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2
              osExtensionsImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:f9e8d7c6b5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a0f9e8
      expectedStatusError: "a RFC 1123 subdomain must consist of lower case alphanumeric characters, '-' or '.', and must start and end with an alphanumeric character."

    - name: Should reject stream name that is too long
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
      updated: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
        status:
          defaultStream: "rhel-coreos"
          availableStreams:
            - name: "this-is-a-very-long-stream-name-that-exceeds-the-maximum-allowed-length-of-253-characters-for-rfc1123-subdomain-validation-which-is-used-to-ensure-compatibility-with-dns-and-kubernetes-naming-standards-and-this-string-needs-to-be-even-longer-to-properly-test-the-limit"
              osImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2
              osExtensionsImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:f9e8d7c6b5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a0f9e8
            - name: "rhel-coreos"
              osImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2
              osExtensionsImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:f9e8d7c6b5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a0f9e8
      expectedStatusError: "status.availableStreams[0].name: Too long: may not be more than 253 bytes"

    - name: Should reject image URL without proper host format
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
      updated: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
        status:
          defaultStream: "rhel-coreos"
          availableStreams:
            - name: rhel-coreos
              osImage: invalid_host/image@sha256:a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2
              osExtensionsImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:f9e8d7c6b5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a0f9e8
      expectedStatusError: "the OCI Image name should follow the host[:port][/namespace]/name format"

    - name: Should accept defaultStream that references an existing stream
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
      updated: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
        status:
          defaultStream: rhel-coreos
          availableStreams:
            - name: rhel-coreos
              osImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2
              osExtensionsImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:f9e8d7c6b5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a0f9e8
            - name: rhel10-coreos
              osImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b
              osExtensionsImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:9f8e7d6c5b4a3f2e1d0c9b8a7f6e5d4c3b2a1f0e9d8c7b6a5f4e3d2c1b0a9f8e
      expected: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
        status:
          defaultStream: rhel-coreos
          availableStreams:
            - name: rhel-coreos
              osImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2
              osExtensionsImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:f9e8d7c6b5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a0f9e8
            - name: rhel10-coreos
              osImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b
              osExtensionsImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:9f8e7d6c5b4a3f2e1d0c9b8a7f6e5d4c3b2a1f0e9d8c7b6a5f4e3d2c1b0a9f8e

    - name: Should reject an status update without defaultStream
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
      updated: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
        status:
          availableStreams:
            - name: rhel-coreos
              osImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2
              osExtensionsImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:f9e8d7c6b5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a0f9e8
      expectedStatusError: "status.defaultStream: Required value"

    - name: Should reject an status update without availableStreams
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
      updated: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
        status:
          defaultStream: rhel-coreos
      expectedStatusError: "status.availableStreams: Required value"

    - name: Should reject an status update with empty availableStreams
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
      updated: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
        status:
          defaultStream: rhel-coreos
          availableStreams: []
      expectedStatusError: "status.availableStreams: Invalid value: 0: availableStreams in body should have at least 1 items"

    - name: Should reject defaultStream that does not reference an existing stream
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
      updated: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
        status:
          defaultStream: non-existent-stream
          availableStreams:
            - name: rhel-coreos
              osImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2
              osExtensionsImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:f9e8d7c6b5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a0f9e8
      expectedStatusError: "defaultStream must reference a stream name from availableStreams"

    - name: Should reject defaultStream with invalid characters
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
      updated: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
        status:
          defaultStream: "invalid@stream!"
          availableStreams:
            - name: rhel-coreos
              osImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2
              osExtensionsImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:f9e8d7c6b5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a0f9e8
      expectedStatusError: "a RFC 1123 subdomain must consist of lower case alphanumeric characters, '-' or '.', and must start and end with an alphanumeric character."

    - name: Should reject defaultStream that is too long
      initial: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
      updated: |
        apiVersion: machineconfiguration.openshift.io/v1alpha1
        kind: OSImageStream
        metadata:
          name: cluster
        spec:
          defaultStream: rhel-coreos
        status:
          defaultStream: "this-is-a-very-long-stream-name-that-exceeds-the-maximum-allowed-length-of-253-characters-for-rfc1123-subdomain-validation-which-is-used-to-ensure-compatibility-with-dns-and-kubernetes-naming-standards-and-this-string-needs-to-be-even-longer-to-properly-test-the-limit"
          availableStreams:
            - name: rhel-coreos
              osImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2
              osExtensionsImage: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:f9e8d7c6b5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a0f9e8
      expectedStatusError: "status.defaultStream: Too long: may not be more than 253 bytes"
