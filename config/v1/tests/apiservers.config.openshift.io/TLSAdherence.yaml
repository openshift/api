apiVersion: apiextensions.k8s.io/v1
name: "APIServer"
crdName: apiservers.config.openshift.io
featureGates:
- TLSAdherence
tests:
  onCreate:
    - name: Should be able to create with tlsAdherence set to LegacyExternalAPIServerComponentsOnly
      initial: |
        apiVersion: config.openshift.io/v1
        kind: APIServer
        spec:
          tlsAdherence: LegacyExternalAPIServerComponentsOnly
      expected: |
        apiVersion: config.openshift.io/v1
        kind: APIServer
        spec:
          audit:
            profile: Default
          tlsAdherence: LegacyExternalAPIServerComponentsOnly
    - name: Should be able to create with tlsAdherence set to StrictAllComponents
      initial: |
        apiVersion: config.openshift.io/v1
        kind: APIServer
        spec:
          tlsAdherence: StrictAllComponents
      expected: |
        apiVersion: config.openshift.io/v1
        kind: APIServer
        spec:
          audit:
            profile: Default
          tlsAdherence: StrictAllComponents
    - name: Should reject invalid tlsAdherence value
      initial: |
        apiVersion: config.openshift.io/v1
        kind: APIServer
        spec:
          tlsAdherence: InvalidValue
      expectedError: 'spec.tlsAdherence: Unsupported value: "InvalidValue": supported values: "LegacyExternalAPIServerComponentsOnly", "StrictAllComponents"'
  onUpdate:
    - name: Should be able to update tlsAdherence from LegacyExternalAPIServerComponentsOnly to StrictAllComponents
      initial: |
        apiVersion: config.openshift.io/v1
        kind: APIServer
        spec:
          tlsAdherence: LegacyExternalAPIServerComponentsOnly
      updated: |
        apiVersion: config.openshift.io/v1
        kind: APIServer
        spec:
          tlsAdherence: StrictAllComponents
      expected: |
        apiVersion: config.openshift.io/v1
        kind: APIServer
        spec:
          audit:
            profile: Default
          tlsAdherence: StrictAllComponents
    - name: Should be able to update tlsAdherence from StrictAllComponents to LegacyExternalAPIServerComponentsOnly
      initial: |
        apiVersion: config.openshift.io/v1
        kind: APIServer
        spec:
          tlsAdherence: StrictAllComponents
      updated: |
        apiVersion: config.openshift.io/v1
        kind: APIServer
        spec:
          tlsAdherence: LegacyExternalAPIServerComponentsOnly
      expected: |
        apiVersion: config.openshift.io/v1
        kind: APIServer
        spec:
          audit:
            profile: Default
          tlsAdherence: LegacyExternalAPIServerComponentsOnly
    - name: Should not allow removing tlsAdherence once set
      initial: |
        apiVersion: config.openshift.io/v1
        kind: APIServer
        spec:
          tlsAdherence: StrictAllComponents
      updated: |
        apiVersion: config.openshift.io/v1
        kind: APIServer
        spec: {}
      expectedError: "tlsAdherence may not be removed once set"
